<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis, 天启联盟">
    <meta name="description" content="一、前言该技术博客是关于尚硅谷最新发布的Redis教程的笔记总结，希望能在这里分享出来，为大家带来帮助



二、NoSQL数据库简介1.技术发展技术的分类：

解决功能性的问题：Java、Jsp、RDBMS、Tomcat、HTML、Lin">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis | 天启联盟</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="天启联盟" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">天启联盟</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">天启联盟</div>
        <div class="logo-desc">
            
            xx项目xx急,自己事情靠自己
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Java/" class="post-category">
                                Java
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-03
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-01-03
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    20.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    78 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>该技术博客是关于尚硅谷最新发布的Redis教程的笔记总结，希望能在这里分享出来，为大家带来帮助</p>
<blockquote>
<hr>
</blockquote>
<h1 id="二、NoSQL数据库简介"><a href="#二、NoSQL数据库简介" class="headerlink" title="二、NoSQL数据库简介"></a>二、NoSQL数据库简介</h1><h2 id="1-技术发展"><a href="#1-技术发展" class="headerlink" title="1.技术发展"></a>1.技术发展</h2><p>技术的分类：</p>
<ol>
<li>解决功能性的问题：Java、Jsp、RDBMS、Tomcat、HTML、Linux、JDBC、SVN1. 解决扩展性的问题：Struts、Spring、SpringMVC、Hibernate、Mybatis1. 解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、MQ、ElasticSearch<h3 id="1-1-Web1-0时代"><a href="#1-1-Web1-0时代" class="headerlink" title="1.1 Web1.0时代"></a>1.1 Web1.0时代</h3></li>
</ol>
<p>Web1.0的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。 <img src="https://img-blog.csdnimg.cn/20210420153042580.png" alt="在这里插入图片描述"></p>
<h3 id="1-2-Web2-0时代"><a href="#1-2-Web2-0时代" class="headerlink" title="1.2 Web2.0时代"></a>1.2 Web2.0时代</h3><p>随着Web2.0的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。 <img src="https://img-blog.csdnimg.cn/20210420153100849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="1-3-解决CPU及内存压力"><a href="#1-3-解决CPU及内存压力" class="headerlink" title="1.3 解决CPU及内存压力"></a>1.3 解决CPU及内存压力</h3><img src="https://img-blog.csdnimg.cn/20210420153116276.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<p>==什么是Session? 服务器为了保存用户状态而创建的一个特殊的对象==</p>
<h3 id="1-4-解决IO压力"><a href="#1-4-解决IO压力" class="headerlink" title="1.4 解决IO压力"></a>1.4 解决IO压力</h3><img src="https://img-blog.csdnimg.cn/20210420153131712.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="2-NoSQL数据库"><a href="#2-NoSQL数据库" class="headerlink" title="2.NoSQL数据库"></a>2.NoSQL数据库</h2><h3 id="2-1-NoSQL数据库概述"><a href="#2-1-NoSQL数据库概述" class="headerlink" title="2.1 NoSQL数据库概述"></a>2.1 NoSQL数据库概述</h3><p>NoSQL(<mark>Not Only SQL</mark>)，意即“不仅仅是SQL”，泛指非关系型的数据库。</p>
<p>NoSQL 不依赖业务逻辑方式存储，而以简单的key-value模式存储。因此大大的增加了数据库的扩展能力。</p>
<ul>
<li>不遵循SQL标准- 不支持ACID- 远超于SQL的性能<h3 id="2-2-NoSQL适用场景"><a href="#2-2-NoSQL适用场景" class="headerlink" title="2.2 NoSQL适用场景"></a>2.2 NoSQL适用场景</h3></li>
<li>对数据高并发的读写- 海量数据的读写- 对数据高可扩展性的<h3 id="2-3-NoSQL不适用场景"><a href="#2-3-NoSQL不适用场景" class="headerlink" title="2.3 NoSQL不适用场景"></a>2.3 NoSQL不适用场景</h3></li>
<li>需要事务支持- 基于sql的结构化查询存储，处理复杂的关系,需要即席查询。- </li>
<li><mark>用不着sql的和用了sql也不行的情况，请考虑用NoSql</mark></li>
</ul>
<h3 id="2-4-常见的NoSQL数据库"><a href="#2-4-常见的NoSQL数据库" class="headerlink" title="2.4 常见的NoSQL数据库"></a>2.4 常见的NoSQL数据库</h3><blockquote>
<p> Memcache <img src="https://img-blog.csdnimg.cn/20210420152231999.png" alt="在这里插入图片描述"> </p>
</blockquote>
<blockquote>
<p> Redis <img src="https://img-blog.csdnimg.cn/20210420152307510.png" alt="在这里插入图片描述"> </p>
</blockquote>
<blockquote>
<p> MongoDB <img src="https://img-blog.csdnimg.cn/20210420152401914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p>
</blockquote>
<h2 id="3-行式存储数据库（大数据时代）"><a href="#3-行式存储数据库（大数据时代）" class="headerlink" title="3.行式存储数据库（大数据时代）"></a>3.行式存储数据库（大数据时代）</h2><h3 id="3-1-行级数据库"><a href="#3-1-行级数据库" class="headerlink" title="3.1 行级数据库"></a>3.1 行级数据库</h3><img src="https://img-blog.csdnimg.cn/20210420153159517.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h3 id="3-2-列级数据库"><a href="#3-2-列级数据库" class="headerlink" title="3.2 列级数据库"></a>3.2 列级数据库</h3><img src="https://img-blog.csdnimg.cn/20210420153217549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<blockquote>
<p> 常见的列级数据库包括：Hbase、Cassandra等…这里就不做过多介绍 <img src="https://img-blog.csdnimg.cn/2021042015323582.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210420153243757.png" alt="在这里插入图片描述"> </p>
</blockquote>
<h2 id="4-图关系型数据库"><a href="#4-图关系型数据库" class="headerlink" title="4.图关系型数据库"></a>4.图关系型数据库</h2><blockquote>
<p> 说到图关系型数据库，首先应该想到的就是：<strong>Neo4j</strong> <img src="https://img-blog.csdnimg.cn/20210420153311816.png" alt="在这里插入图片描述"> 主要应用：<font color="red">社会关系</font>，<font color="blueviolet">公共交通网络</font>，<font color="cornflowerblue">地图及网络拓谱</font>(n*(n-1)/2) <img src="https://img-blog.csdnimg.cn/20210420153338579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p>
</blockquote>
<h2 id="5-DB-Engines-数据库排名"><a href="#5-DB-Engines-数据库排名" class="headerlink" title="5.DB-Engines 数据库排名"></a>5.DB-Engines 数据库排名</h2><p>排名链接： <img src="https://img-blog.csdnimg.cn/20210420153457688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="三、Redis概述及安装"><a href="#三、Redis概述及安装" class="headerlink" title="三、Redis概述及安装"></a>三、Redis概述及安装</h1><h2 id="1-Redis概述"><a href="#1-Redis概述" class="headerlink" title="1.Redis概述"></a>1.Redis概述</h2><blockquote>
</blockquote>
<ul>
<li>Redis是一个开源的key-value存储系统。- </li>
<li>和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合)和hash（哈希类型）。-</li>
<li> 这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。- </li>
<li>在此基础上，Redis支持各种不同方式的排序。- </li>
<li>与memcached一样，为了保证效率，数据都是缓存在内存中。- 区别的是Redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件。</li>
<li><ul>
<li>并且在此基础上实现了master-slave(主从)同步。 </li>
</ul>
</li>
</ul>
<h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2.应用场景"></a>2.应用场景</h2><h3 id="2-1-配合关系型数据库做高速缓存"><a href="#2-1-配合关系型数据库做高速缓存" class="headerlink" title="2.1 配合关系型数据库做高速缓存"></a>2.1 配合关系型数据库做高速缓存</h3><ul>
<li>高频次，热门访问的数据，降低数据库IO- 分布式架构，做session共享<img src="https://img-blog.csdnimg.cn/20210420154051187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<h3 id="2-2-多样的数据结构存储持久化数据"><a href="#2-2-多样的数据结构存储持久化数据" class="headerlink" title="2.2 多样的数据结构存储持久化数据"></a>2.2 多样的数据结构存储持久化数据</h3><img src="https://img-blog.csdnimg.cn/20210420154137843.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="3-Redis安装"><a href="#3-Redis安装" class="headerlink" title="3.Redis安装"></a>3.Redis安装</h2><h3 id="3-1-安装步骤"><a href="#3-1-安装步骤" class="headerlink" title="3.1 安装步骤"></a>3.1 安装步骤</h3><p>毕竟这是一篇关于Redis的教程笔记，所以该技术博客中不会详细的讲解Redis数据库的安装步骤，没有安装的小伙伴可以参考下方博客链接：</p>
<p>如果大家觉得安装流程很麻烦，可以关注我的公众号：<mark>Coder 徐</mark> 回复关键字：<mark>Redis</mark>，我会把Redis安装压缩包分享给大家，如果<strong>安装过程 出现问题</strong>，也可以通过公众号联系我为您解惑，感谢大家的支持！ <img src="https://img-blog.csdnimg.cn/20210420155438438.png" alt="在这里插入图片描述"></p>
<h3 id="3-2-安装目录"><a href="#3-2-安装目录" class="headerlink" title="3.2 安装目录"></a>3.2 安装目录</h3><p>Redis数据库成功安装后，<strong>默认安装目录为：/usr/local/bin</strong></p>
<p>查看默认安装目录：</p>
<blockquote>
<p> redis-benchmark：性能测试工具，可以在自己本子运行，看看自己本子性能如何 redis-check-aof：修复有问题的AOF文件，rdb和aof后面讲 redis-check-dump：修复有问题的dump.rdb文件 redis-sentinel：Redis集群使用 <strong>redis-server</strong>：Redis服务器启动命令 <strong>redis-cli</strong>：客户端，操作入口 </p>
</blockquote>
<h3 id="3-3-前台启动（不推荐）"><a href="#3-3-前台启动（不推荐）" class="headerlink" title="3.3 前台启动（不推荐）"></a>3.3 前台启动（不推荐）</h3><p>前台启动，命令行窗口不能关闭，否则服务器停止！</p>
<p>启动命令：</p>
<pre class="line-numbers language-none"><code class="language-none">redis-server
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-blog.csdnimg.cn/202104202019089.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h3 id="3-4-后台启动（推荐）"><a href="#3-4-后台启动（推荐）" class="headerlink" title="3.4 后台启动（推荐）"></a>3.4 后台启动（推荐）</h3><ol>
<li>将redis.conf复制到其他目录下： <img src="https://img-blog.csdnimg.cn/20210420202655211.png" alt="在这里插入图片描述">1. 修改redis.conf(128行)文件将里面的daemonize no 改成 yes，让服务在后台启动 <img src="https://img-blog.csdnimg.cn/20210420205654374.png" alt="在这里插入图片描述">1. 启动Redis：redis-server /etc/redis.conf <img src="https://img-blog.csdnimg.cn/20210420221959136.png" alt="在这里插入图片描述">1. 用客户端访问：redis-cli <img src="https://img-blog.csdnimg.cn/20210420222550688.png" alt="在这里插入图片描述">1. 测试验证： ping <img src="https://img-blog.csdnimg.cn/20210420223003701.png" alt="在这里插入图片描述">1. Redis关闭 单实例关闭：redis-cli shutdown 也可以进入终端后再关闭：shutdown <img src="https://img-blog.csdnimg.cn/20210420223828624.png" alt="在这里插入图片描述"><h2 id="4-Redis相关知识介绍"><a href="#4-Redis相关知识介绍" class="headerlink" title="4.Redis相关知识介绍"></a>4.Redis相关知识介绍</h2></li>
</ol>
<img src="https://img-blog.csdnimg.cn/20210421161901343.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 

<p><mark>Redis是单线程+多路IO复用技术</mark>，</p>
<p>与Memcache三点不同:</p>
<ul>
<li> 支持多数据类型，</li>
<li>支持持久化，</li>
<li>单线程+多路IO复用</li>
</ul>
<blockquote>
<p> 多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池） </p>
</blockquote>
<h1 id="四、常用五大数据类型"><a href="#四、常用五大数据类型" class="headerlink" title="四、常用五大数据类型"></a>四、常用五大数据类型</h1><h2 id="1-Redis中的键（key）"><a href="#1-Redis中的键（key）" class="headerlink" title="1.Redis中的键（key）"></a>1.Redis中的键（key）</h2><p>查看当前库所有key（匹配：keys *1）：</p>
<pre class="line-numbers language-none"><code class="language-none">keys *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>判断某个key是否存在：</p>
<pre class="line-numbers language-none"><code class="language-none">exists key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看你的key是什么类型：</p>
<pre class="line-numbers language-none"><code class="language-none">type key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除指定的key数据：</p>
<pre class="line-numbers language-none"><code class="language-none">del key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>根据value选择非阻塞删除：</p>
<pre class="line-numbers language-none"><code class="language-none">// 仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作
unlink key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>为给定的key设置过期时间，10秒：</p>
<pre class="line-numbers language-none"><code class="language-none">expire key 10 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看还有多少秒过期，-1表示永不过期，-2表示已过期：</p>
<pre class="line-numbers language-none"><code class="language-none">ttl key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">select命令：切换数据库
dbsize命令：查看当前数据库的key的数量
flushdb命令：清空当前库
flushall命令：通杀全部库<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-数据类型—字符串（String）"><a href="#2-数据类型—字符串（String）" class="headerlink" title="2.数据类型—字符串（String）"></a>2.数据类型—字符串（String）</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。</p>
<p>String类型是<strong>二进制安全的</strong>。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</p>
<p>String类型是Redis**==最基本的数据类型==<strong>，一个Redis中字符串value最多可以是</strong>512M**</p>
<h3 id="2-2-常用命令"><a href="#2-2-常用命令" class="headerlink" title="2.2 常用命令"></a>2.2 常用命令</h3><p>添加键值对：</p>
<pre class="line-numbers language-none"><code class="language-none">set key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询对应键值：</p>
<pre class="line-numbers language-none"><code class="language-none">get key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将给定的value追加到原值的末尾：</p>
<pre class="line-numbers language-none"><code class="language-none">append key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>获得值的长度：</p>
<pre class="line-numbers language-none"><code class="language-none">strlen key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>只有在key不存在时设置key的值：</p>
<pre class="line-numbers language-none"><code class="language-none">setnx key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将 key 中储存的数字值增1 只能对数字值操作，如果为空，新增值为1</p>
<pre class="line-numbers language-none"><code class="language-none">incr key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将 key 中储存的数字值减1 只能对数字值操作，如果为空，新增值为-1</p>
<pre class="line-numbers language-none"><code class="language-none">decr key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将key中储存的数字值增减，自定义步长：</p>
<pre class="line-numbers language-none"><code class="language-none">incrby / decrby key 数字值<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>说到incr命令，这里有个扩展知识点：</p>
<blockquote>
<p>  <strong>Redis具有原子性</strong>（不是事务中的原子性） <img src="https://img-blog.csdnimg.cn/20210421175901805.png" alt="在这里插入图片描述"> 所谓<strong>原子操作</strong>是指不会被线程调度机制打断的操作； 这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch（切换到另一个线程） </p>
<p> （1）在单线程中， 能够在单条指令中完成的操作都可以认为是”原子操作”，因为中断只能发生于指令之间。 （2）在多线程中，不能被其它进程（线程）打断的操作就叫原子操作。 Redis单命令的原子性主要得益于<strong>Redis的单线程</strong>。 </p>
</blockquote>
<p>同时设置一个或多个key-value对：</p>
<pre class="line-numbers language-none"><code class="language-none">mset key1 value1 key2 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同时获取一个或多个value：</p>
<pre class="line-numbers language-none"><code class="language-none">mget key1 key2 key3...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同时设置一个或多个key-value对，当且仅当所有给定key都不存在：</p>
<pre class="line-numbers language-none"><code class="language-none">// 原子性，有一个失败则都失败
msetnx key1 value1 key2 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>获得值的范围，类似java中的substring，前包，后包</p>
<pre class="line-numbers language-none"><code class="language-none">getrange key 起始位置 结束位置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>用value覆写key所储存的字符串值，从起始位置开始(索引从0开始)：</p>
<pre class="line-numbers language-none"><code class="language-none">setrange key 起始位置 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>设置键值的同时，设置过期时间，单位秒：</p>
<pre class="line-numbers language-none"><code class="language-none">setex key 过期时间 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>以新换旧，设置了新值同时获得旧值：</p>
<pre class="line-numbers language-none"><code class="language-none">getset key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-3-数据结构"><a href="#2-3-数据结构" class="headerlink" title="2.3 数据结构"></a>2.3 数据结构</h3><p>String的数据结构为**==简单动态字符串==**(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配 <img src="https://img-blog.csdnimg.cn/20210421185559186.png" alt="在这里插入图片描述"> 如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h2 id="3-数据类型—列表（List）"><a href="#3-数据类型—列表（List）" class="headerlink" title="3.数据类型—列表（List）"></a>3.数据类型—列表（List）</h2><h3 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h3><p><mark>单键多值</mark></p>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）</p>
<p>它的底层实际是个<strong>双向链表</strong>，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。 <img src="https://img-blog.csdnimg.cn/20210421185811418.png" alt="在这里插入图片描述"></p>
<h3 id="3-2-常用命令"><a href="#3-2-常用命令" class="headerlink" title="3.2 常用命令"></a>3.2 常用命令</h3><p>从左边/右边插入一个或多个值：</p>
<pre class="line-numbers language-none"><code class="language-none">lpush / rpush key1 value1 key2 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>从左边/右边吐出一个值。<strong>值在键在，值光键亡</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">lpop / rpop key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>从key1列表右边吐出一个值，插到key2列表左边：</p>
<pre class="line-numbers language-none"><code class="language-none">rpoplpush key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>按照索引下标获得元素(从左到右)：</p>
<pre class="line-numbers language-none"><code class="language-none">lrange key 起始索引 结束索引
lrange key 0 -1   //0左边第一个，-1右边第一个，（0-1表示获取所有）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>按照索引下标获得元素(从左到右)：</p>
<pre class="line-numbers language-none"><code class="language-none">lindex key 索引号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>获得列表长度：</p>
<pre class="line-numbers language-none"><code class="language-none">llen key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在value的前面插入newvalue插入值：</p>
<pre class="line-numbers language-none"><code class="language-none">linsert key before value newvalue<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>从左边删除n个value(从左到右)：</p>
<pre class="line-numbers language-none"><code class="language-none">lrem key n value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将列表key下标为index的值替换成value：</p>
<pre class="line-numbers language-none"><code class="language-none">lset key index value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="3-3-数据结构"><a href="#3-3-数据结构" class="headerlink" title="3.3 数据结构"></a>3.3 数据结构</h3><p>List的数据结构为快速链表**==quickList==**</p>
<p>首先在列表==元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。==</p>
<p>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p>当数据量比较多的时候才会改成quicklist。</p>
<p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p><img src="https://img-blog.csdnimg.cn/20210421190034419.png" alt="在这里插入图片描述"> Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h2 id="4-数据类型—集合（Set）"><a href="#4-数据类型—集合（Set）" class="headerlink" title="4.数据类型—集合（Set）"></a>4.数据类型—集合（Set）</h2><h3 id="4-1-简介"><a href="#4-1-简介" class="headerlink" title="4.1 简介"></a>4.1 简介</h3><p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以<mark>自动排重</mark>的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</p>
<p>Redis的Set是string类型的<mark>无序集合。它底层其实是一个value为null的hash表</mark>，所以添加，删除，查找的**复杂度都是O(1)**。</p>
<p>一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变</p>
<h3 id="4-2-常用命令"><a href="#4-2-常用命令" class="headerlink" title="4.2 常用命令"></a>4.2 常用命令</h3><p>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略：</p>
<pre class="line-numbers language-none"><code class="language-none">sadd key value1 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>取出该集合的所有值：</p>
<pre class="line-numbers language-none"><code class="language-none">smembers key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>判断集合key是否为含有该value值，有1，没有0：</p>
<pre class="line-numbers language-none"><code class="language-none">sismember key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回该集合的元素个数：</p>
<pre class="line-numbers language-none"><code class="language-none">scard key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除集合中的某个元素：</p>
<pre class="line-numbers language-none"><code class="language-none">srem key value1 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>随机从该集合中吐出一个值：</p>
<pre class="line-numbers language-none"><code class="language-none">spop key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>随机从该集合中取出n个值。不会从集合中删除：</p>
<pre class="line-numbers language-none"><code class="language-none">srandmember key n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>把集合中一个值从一个集合移动到另一个集合：</p>
<pre class="line-numbers language-none"><code class="language-none">smove 集合1 集合2 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回两个集合的交集元素：</p>
<pre class="line-numbers language-none"><code class="language-none">sinter key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回两个集合的并集元素：</p>
<pre class="line-numbers language-none"><code class="language-none">sunion key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回两个集合的差集元素(key1中的，不包含key2中的)：</p>
<pre class="line-numbers language-none"><code class="language-none">sdiff key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="4-3-数据结构"><a href="#4-3-数据结构" class="headerlink" title="4.3 数据结构"></a>4.3 数据结构</h3><p>Set数据结构是dict字典，字典是用哈希表实现的。</p>
<p>==<strong>Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象</strong>==。Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p>
<h2 id="5-数据类型—哈希（Hash）"><a href="#5-数据类型—哈希（Hash）" class="headerlink" title="5.数据类型—哈希（Hash）"></a>5.数据类型—哈希（Hash）</h2><h3 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1 简介"></a>5.1 简介</h3><p>Redis hash 是一个键值对集合。</p>
<p>Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
<p>类似Java里面的Map&lt;String,Object&gt;</p>
<p>用户ID为查找的key，存储的value用户对象包含姓名，年龄，生日等信息，如果用普通的key/value结构来存储</p>
<p>主要有以下2种存储方式： <img src="https://img-blog.csdnimg.cn/20210421204522399.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="5-2-常用命令"><a href="#5-2-常用命令" class="headerlink" title="5.2 常用命令"></a>5.2 常用命令</h3><p>给key集合中的field键赋值value：</p>
<pre class="line-numbers language-none"><code class="language-none">hset key field value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>从key1集合field取出 value ：</p>
<pre class="line-numbers language-none"><code class="language-none">hget key1 field<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>批量设置hash的值：</p>
<pre class="line-numbers language-none"><code class="language-none">hmset key1 field1 value1 field2 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看哈希表 key 中，给定域 field 是否存在：</p>
<pre class="line-numbers language-none"><code class="language-none">hexists key1 field<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>列出该hash集合的所有field：</p>
<pre class="line-numbers language-none"><code class="language-none">hkeys key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>列出该hash集合的所有value：</p>
<pre class="line-numbers language-none"><code class="language-none">hvals key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>为哈希表 key 中的域 field 的值加上增量 1 -1</p>
<pre class="line-numbers language-none"><code class="language-none">hincrby key field 增量<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在：</p>
<pre class="line-numbers language-none"><code class="language-none">hsetnx key field value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-3-数据结构"><a href="#5-3-数据结构" class="headerlink" title="5.3 数据结构"></a>5.3 数据结构</h3><p>Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</p>
<h2 id="6-数据类型—有序集合（Zset）"><a href="#6-数据类型—有序集合（Zset）" class="headerlink" title="6.数据类型—有序集合（Zset）"></a>6.数据类型—有序集合（Zset）</h2><h3 id="6-1-简介"><a href="#6-1-简介" class="headerlink" title="6.1 简介"></a>6.1 简介</h3><p>Redis有序集合zset与普通集合set非常相似，是一个<mark>没有重复元素</mark>的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。<mark>集合的成员是唯一的，但是评分可以是重复了</mark> 。</p>
<p>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h3 id="6-2-常用命令"><a href="#6-2-常用命令" class="headerlink" title="6.2 常用命令"></a>6.2 常用命令</h3><p>将一个或多个 member 元素及其 score 值加入到有序集 key 当中：</p>
<pre class="line-numbers language-none"><code class="language-none">zadd key score1 value1 score2 value2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回有序集 key 中，下标在start、stop之间的元素 带WITHSCORES，可以让分数一起和值返回到结果集：</p>
<pre class="line-numbers language-none"><code class="language-none">zrange key start stop [withscores]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列：</p>
<pre class="line-numbers language-none"><code class="language-none">zrangebyscore key min max [withscores] [limit offset count]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同上，改为从大到小排列：</p>
<pre class="line-numbers language-none"><code class="language-none">zrevrangebyscore key max min [withscores] [limit offset count]  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>为元素的score加上增量：</p>
<pre class="line-numbers language-none"><code class="language-none">zincrby key 增量 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除该集合下，指定值的元素：</p>
<pre class="line-numbers language-none"><code class="language-none">zrem key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>统计该集合，分数区间内的元素个数：</p>
<pre class="line-numbers language-none"><code class="language-none">zcount key min max <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回该值在集合中的排名，从0开始：</p>
<pre class="line-numbers language-none"><code class="language-none">zrank key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="6-3-数据结构"><a href="#6-3-数据结构" class="headerlink" title="6.3 数据结构"></a>6.3 数据结构</h3><p>SortedSet(zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p>
<p>zset底层使用了两个数据结构：</p>
<ol>
<li>hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。1. 跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。<h3 id="6-4-跳跃表（跳表）"><a href="#6-4-跳跃表（跳表）" class="headerlink" title="6.4 跳跃表（跳表）"></a>6.4 跳跃表（跳表）</h3></li>
<li>简介： 有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。1. 实例： 对比有序链表和跳跃表，从链表中查询出51<blockquote>
<p>有序链表 <img src="https://img-blog.csdnimg.cn/20210421205208524.png" alt="在这里插入图片描述"> 要查找值为51的元素，需要从第一个元素开始依次查找、比较才能找到。共需要6次比较。 </p>
</blockquote>
</li>
</ol>
<blockquote>
<p> 跳跃表 <img src="https://img-blog.csdnimg.cn/20210421205430975.png" alt="在这里插入图片描述"> 从第2层开始，1节点比51节点小，向后比较。 21节点比51节点小，继续向后比较，后面就是NULL了，所以从21节点向下到第1层 在第1层，41节点比51节点小，继续向后，61节点比51节点大，所以从41向下 在第0层，51节点为要查找的节点，节点被找到，共查找4次。 从此可以看出跳跃表比有序链表效率要高 3</p>
</blockquote>
<h1 id="五、Redis配置文件介绍"><a href="#五、Redis配置文件介绍" class="headerlink" title="五、Redis配置文件介绍"></a>五、Redis配置文件介绍</h1><p>自定义目录：/etc/redis.conf</p>
<h2 id="1-Units单位"><a href="#1-Units单位" class="headerlink" title="1.Units单位"></a>1.Units单位</h2><p>配置大小单位,开头定义了一些基本的度量单位，只支持bytes，不支持bit 大小写不敏感 <img src="https://img-blog.csdnimg.cn/20210422210430289.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="2-INCLUDES包含"><a href="#2-INCLUDES包含" class="headerlink" title="2.INCLUDES包含"></a>2.INCLUDES包含</h2><p><img src="https://img-blog.csdnimg.cn/20210422210458252.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 类似jsp中的include，多实例的情况可以把公用的配置文件提取出来</p>
<h2 id="3-网络相关配置"><a href="#3-网络相关配置" class="headerlink" title="3.网络相关配置"></a>3.网络相关配置</h2><h3 id="3-1-bind"><a href="#3-1-bind" class="headerlink" title="3.1 bind"></a>3.1 bind</h3><p>默认情况bind=127.0.0.1只能接受本机的访问请求 不写的情况下，无限制接受任何ip地址的访问 生产环境肯定要写你应用服务器的地址；服务器是需要远程访问的，所以需要将其注释掉</p>
<p><mark>如果开启了protected-mode，那么在没有设定bind ip且没有设密码的情况下，Redis只允许接受本机的响应</mark> <img src="https://img-blog.csdnimg.cn/20210422210720413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 保存配置，停止服务，重启启动查看进程，不再是本机访问了。 <img src="https://img-blog.csdnimg.cn/20210422210750928.png" alt="在这里插入图片描述"></p>
<h3 id="3-2-protected-mode"><a href="#3-2-protected-mode" class="headerlink" title="3.2 protected-mode"></a>3.2 protected-mode</h3><p>将本机访问保护模式设置no <img src="https://img-blog.csdnimg.cn/20210422210945981.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="3-3-Port"><a href="#3-3-Port" class="headerlink" title="3.3 Port"></a>3.3 Port</h3><p>端口号，默认 6379 <img src="https://img-blog.csdnimg.cn/202104222110127.png" alt="在这里插入图片描述"></p>
<h3 id="3-4-tcp-backlog"><a href="#3-4-tcp-backlog" class="headerlink" title="3.4 tcp-backlog"></a>3.4 tcp-backlog</h3><p>设置tcp的backlog，backlog其实是一个连接队列，backlog队列总和=未完成三次握手队列 + 已经完成三次握手队列。</p>
<p>在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。</p>
<p>注意Linux内核会将这个值减小到/proc/sys/net/core/somaxconn的值（128），所以需要确认增大/proc/sys/net/core/somaxconn和/proc/sys/net/ipv4/tcp_max_syn_backlog（128）两个值来达到想要的效果 <img src="https://img-blog.csdnimg.cn/20210422211103933.png" alt="在这里插入图片描述"></p>
<h3 id="3-5-timeout"><a href="#3-5-timeout" class="headerlink" title="3.5 timeout"></a>3.5 timeout</h3><p>一个空闲的客户端维持多少秒会关闭，0表示关闭该功能。即<strong>永不关闭</strong>。 <img src="https://img-blog.csdnimg.cn/20210422211150207.png" alt="在这里插入图片描述"></p>
<h3 id="3-6-tcp-keepalive"><a href="#3-6-tcp-keepalive" class="headerlink" title="3.6 tcp-keepalive"></a>3.6 tcp-keepalive</h3><p>对访问客户端的一种<strong>心跳检测</strong>，每个n秒检测一次。</p>
<p>单位为秒，如果设置为0，则不会进行Keepalive检测，建议设置成60 <img src="https://img-blog.csdnimg.cn/20210422211216291.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="4-GENERAL通用"><a href="#4-GENERAL通用" class="headerlink" title="4.GENERAL通用"></a>4.GENERAL通用</h2><h3 id="4-1-daemonize"><a href="#4-1-daemonize" class="headerlink" title="4.1 daemonize"></a>4.1 daemonize</h3><p>是否为后台进程，设置为yes</p>
<p>守护进程，后台启动 <img src="https://img-blog.csdnimg.cn/20210422211347307.png" alt="在这里插入图片描述"></p>
<h3 id="4-2-pidfile"><a href="#4-2-pidfile" class="headerlink" title="4.2 pidfile"></a>4.2 pidfile</h3><p>存放pid文件的位置，每个实例会产生一个不同的pid文件 <img src="https://img-blog.csdnimg.cn/20210422211553920.png" alt="在这里插入图片描述"></p>
<h3 id="4-3-loglevel"><a href="#4-3-loglevel" class="headerlink" title="4.3 loglevel"></a>4.3 loglevel</h3><p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为<mark>notice</mark></p>
<p>四个级别根据使用阶段来选择，生产环境选择notice 或者warning <img src="https://img-blog.csdnimg.cn/20210422211926383.png" alt="在这里插入图片描述"></p>
<h3 id="4-4-logfile"><a href="#4-4-logfile" class="headerlink" title="4.4 logfile"></a>4.4 logfile</h3><p>日志文件名称 <img src="https://img-blog.csdnimg.cn/20210422212123127.png" alt="在这里插入图片描述"></p>
<h3 id="4-5-databases-16"><a href="#4-5-databases-16" class="headerlink" title="4.5 databases 16"></a>4.5 databases 16</h3><p><mark>设定库的数量 默认16</mark>，默认数据库为0，可以使用SELECT 命令在连接上指定数据库id <img src="https://img-blog.csdnimg.cn/20210422212307214.png" alt="在这里插入图片描述"></p>
<h2 id="5-SECURITY安全"><a href="#5-SECURITY安全" class="headerlink" title="5.SECURITY安全"></a>5.SECURITY安全</h2><h3 id="5-1-设置密码"><a href="#5-1-设置密码" class="headerlink" title="5.1 设置密码"></a>5.1 设置密码</h3><p><img src="https://img-blog.csdnimg.cn/20210422212556618.png" alt="在这里插入图片描述"> 访问密码的查看、设置和取消</p>
<p>在命令中设置密码，只是临时的。重启redis服务器，密码就还原了</p>
<p>永久设置，需要再配置文件中进行设置 <img src="https://img-blog.csdnimg.cn/20210422212622123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="6-LIMITS限制"><a href="#6-LIMITS限制" class="headerlink" title="6.LIMITS限制"></a>6.LIMITS限制</h2><h3 id="6-1-maxclients"><a href="#6-1-maxclients" class="headerlink" title="6.1 maxclients"></a>6.1 maxclients</h3><p>设置redis同时可以与多少个客户端进行连接</p>
<p>默认情况下为10000个客户端。</p>
<p>如果达到了此限制，redis则会拒绝新的连接请求，并且向这些连接请求方发出“max number of clients reached”以作回应。 <img src="https://img-blog.csdnimg.cn/2021042221285939.png" alt="在这里插入图片描述"></p>
<h3 id="6-2-maxmemory"><a href="#6-2-maxmemory" class="headerlink" title="6.2 maxmemory"></a>6.2 maxmemory</h3><p>建议必须设置，否则，将内存占满，造成服务器宕机</p>
<p>设置redis可以使用的内存量。一旦到达内存使用上限，redis将会试图移除内部数据，移除规则可以通过maxmemory-policy来指定。</p>
<p>如果redis无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么redis则会针对那些需要申请内存的指令返回错误信息，比如SET、LPUSH等。</p>
<p>但是对于无内存申请的指令，仍然会正常响应，比如GET等。如果你的redis是主redis（说明你的redis有从redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是“不移除”的情况下，才不用考虑这个因素。 <img src="https://img-blog.csdnimg.cn/20210422213036654.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="6-3-maxmemory-policy"><a href="#6-3-maxmemory-policy" class="headerlink" title="6.3 maxmemory-policy"></a>6.3 maxmemory-policy</h3><p>volatile-lru：使用LRU算法移除key，只对设置了过期时间的键；（最近最少使用）</p>
<p>allkeys-lru：在所有集合key中，使用LRU算法移除key</p>
<p>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</p>
<p>allkeys-random：在所有集合key中，移除随机的key</p>
<p>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</p>
<p>noeviction：不进行移除。针对写操作，只是返回错误信息 <img src="https://img-blog.csdnimg.cn/20210422213200277.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="6-4-maxmemory-samples"><a href="#6-4-maxmemory-samples" class="headerlink" title="6.4 maxmemory-samples"></a>6.4 maxmemory-samples</h3><p>设置样本数量，LRU算法和最小TTL算法都并非是精确的算法，而是估算值，所以你可以设置样本的大小，redis默认会检查这么多个key并选择其中LRU的那个。</p>
<p>一般设置3到7的数字，数值越小样本越不准确，但性能消耗越小。 <img src="https://img-blog.csdnimg.cn/202104222154351.png" alt="在这里插入图片描述"></p>
<h1 id="六、Redis的发布和订阅"><a href="#六、Redis的发布和订阅" class="headerlink" title="六、Redis的发布和订阅"></a>六、Redis的发布和订阅</h1><h2 id="1-什么是发布和订阅"><a href="#1-什么是发布和订阅" class="headerlink" title="1.什么是发布和订阅"></a>1.什么是发布和订阅</h2><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h2 id="2-Redis的发布和订阅"><a href="#2-Redis的发布和订阅" class="headerlink" title="2.Redis的发布和订阅"></a>2.Redis的发布和订阅</h2><ol>
<li>客户端可以订阅频道如下图 <img src="https://img-blog.csdnimg.cn/20210422215853726.png" alt="在这里插入图片描述">1. 当给这个频道发布消息后，消息就会发送给订阅的客户端 <img src="https://img-blog.csdnimg.cn/20210422215910700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h2 id="3-发布订阅命令行实现"><a href="#3-发布订阅命令行实现" class="headerlink" title="3.发布订阅命令行实现"></a>3.发布订阅命令行实现</h2></li>
<li> 打开一个客户端订阅channel1 SUBSCRIBE channel1 <img src="https://img-blog.csdnimg.cn/20210422220044780.png" alt="在这里插入图片描述"> 1.  打开另一个客户端，给channel1发布消息hello publish channel1 hello <img src="https://img-blog.csdnimg.cn/20210422220110970.png" alt="在这里插入图片描述"> 返回的1是订阅者数量 1.  打开第一个客户端可以看到发送的消息 <img src="https://img-blog.csdnimg.cn/20210422220147450.png" alt="在这里插入图片描述"> 注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息 <h1 id="七、Redis新数据类型"><a href="#七、Redis新数据类型" class="headerlink" title="七、Redis新数据类型"></a>七、Redis新数据类型</h1></li>
</ol>
<h2 id="1-Bitmaps"><a href="#1-Bitmaps" class="headerlink" title="1.Bitmaps"></a>1.Bitmaps</h2><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>现代计算机用二进制（位） 作为信息的基础单位， 1个字节等于8位， 例如“abc”字符串是由3个字节组成， 但实际在计算机存储时将其用二进制表示， “abc”分别对应的ASCII码分别是97、 98、 99， 对应的二进制分别是01100001、 01100010和01100011，如下图： <img src="https://img-blog.csdnimg.cn/20210424103605617.png" alt="在这里插入图片描述"> 合理地使用操作位能够有效地提高内存使用率和开发效率。</p>
<p>Redis提供了Bitmaps这个“数据类型”可以实现对位的操作：</p>
<blockquote>
</blockquote>
<ul>
<li>Bitmaps本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。- Bitmaps单独提供了一套命令， 所以在Redis中使用Bitmaps和使用字符串的方法不太相同。可以把Bitmaps想象成一个以位为单位的数组， 数组的每个单元只能存储0和1， 数组的下标在Bitmaps中叫做偏移量。 <img src="https://img-blog.csdnimg.cn/20210424103835451.png" alt="在这里插入图片描述"> </li>
</ul>
<h3 id="1-2-常用命令"><a href="#1-2-常用命令" class="headerlink" title="1.2 常用命令"></a>1.2 常用命令</h3><blockquote>
<p> 1.setbit </p>
</blockquote>
<p>设置Bitmaps中某个偏移量的值（0或1）：</p>
<pre class="line-numbers language-none"><code class="language-none">setbit key offset value
注意：offset:偏移量从0开始<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>实例： 每个独立用户是否访问过网站存放在Bitmaps中， 将访问的用户记做1， 没有访问的用户记做0， 用偏移量作为用户的id。 设置键的第offset个位的值（从0算起） ， 假设现在有20个用户，userid=1， 6， 11， 15， 19的用户对网站进行了访问， 那么当前Bitmaps初始化结果如图： <img src="https://img-blog.csdnimg.cn/20210424104851632.png" alt="在这里插入图片描述"> unique:users:20201106代表2020-11-06这天的独立访问用户的Bitmaps <img src="https://img-blog.csdnimg.cn/20210424104905363.png" alt="在这里插入图片描述"> <mark>注意</mark>： 很多应用的用户id以一个指定数字（例如10000） 开头， 直接将用户id和Bitmaps的偏移量对应势必会造成一定的浪费， 通常的做法是每次做setbit操作时将用户id减去这个指定数字。</p>
<p>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>
<blockquote>
<p> 2.getbit </p>
</blockquote>
<p>获取Bitmaps中某个偏移量的值：</p>
<pre class="line-numbers language-none"><code class="language-none">getbit key offset
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>获取键的第offset位的值（从0开始算）</p>
<p>实例： 获取id=8的用户是否在2020-11-06这天访问过， 返回0说明没有访问过： <img src="https://img-blog.csdnimg.cn/20210424113034370.png" alt="在这里插入图片描述"> 注：因为100根本不存在，所以也是返回0</p>
<blockquote>
<p> 3.bitcount </p>
</blockquote>
<p>统计字符串被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，可以让计数只在特定的位上进行。start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指bit组的字节的下标数，二者皆包含。</p>
<p>统计字符串从start字节到end字节比特值为1的数量：</p>
<pre class="line-numbers language-none"><code class="language-none">bitcount key [start end]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： 计算2022-11-06这天的独立访问用户数量 <img src="https://img-blog.csdnimg.cn/20210424113246302.png" alt="在这里插入图片描述"> start和end代表起始和结束字节数， 下面操作计算用户id在第1个字节到第3个字节之间的独立访问用户数， 对应的用户id是11， 15， 19。 <img src="https://img-blog.csdnimg.cn/20210424113302913.png" alt="在这里插入图片描述"> 举例： K1 【01000001 01000000 00000000 00100001】，对应【0，1，2，3】</p>
<p>bitcount K1 1 2 ： 统计下标1、2字节组中bit=1的个数，即01000000 00000000 –》bitcount K1 1 2 　–》1</p>
<p>bitcount K1 1 3 ： 统计下标1、2字节组中bit=1的个数，即01000000 00000000 00100001 –》bitcount K1 1 3　 –》3</p>
<p>bitcount K1 0 -2 ： 统计下标0到下标倒数第2，字节组中bit=1的个数，即01000001 01000000 00000000 –》bitcount K1 0 -2　 –》3</p>
<p>注意：redis的setbit设置或清除的是bit位置，而bitcount计算的是byte位置。</p>
<blockquote>
<p> 4.bitop </p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">bitop and(or/not/xor) &lt;destkey&gt; [key…]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>bitop是一个复合操作， 它可以做多个Bitmaps的and（交集） 、 or（并集） 、 not（非） 、 xor（异或） 操作并将结果保存在destkey中。</p>
<p>实例： 2020-11-04 日访问网站的userid=1,2,5,9。 setbit unique:users:20201104 1 1 setbit unique:users:20201104 2 1 setbit unique:users:20201104 5 1 setbit unique:users:20201104 9 1</p>
<p>2020-11-03 日访问网站的userid=0,1,4,9。 setbit unique:users:20201103 0 1 setbit unique:users:20201103 1 1 setbit unique:users:20201103 4 1 setbit unique:users:20201103 9 1</p>
<p>计算出两天都访问过网站的用户数量 bitop and unique:users:and:20201104_03 unique:users:20201103unique:users:20201104 <img src="https://img-blog.csdnimg.cn/20210424114043780.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210424114057896.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 计算出任意一天都访问过网站的用户数量（例如月活跃就是类似这种） ， 可以使用or求并集 <img src="https://img-blog.csdnimg.cn/20210424114113709.png" alt="在这里插入图片描述"></p>
<h3 id="1-3-Bitmaps与set对比"><a href="#1-3-Bitmaps与set对比" class="headerlink" title="1.3 Bitmaps与set对比"></a>1.3 Bitmaps与set对比</h3><p>假设网站有1亿用户， 每天独立访问的用户有5千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表 <img src="https://img-blog.csdnimg.cn/20210424114332643.png" alt="在这里插入图片描述"> 很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的 <img src="https://img-blog.csdnimg.cn/20210424114529727.png" alt="在这里插入图片描述"> 但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是0。 <img src="https://img-blog.csdnimg.cn/202104241146254.png" alt="在这里插入图片描述"></p>
<h2 id="2-HyperLogLog"><a href="#2-HyperLogLog" class="headerlink" title="2.HyperLogLog"></a>2.HyperLogLog</h2><h3 id="2-1-简介-1"><a href="#2-1-简介-1" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。</p>
<p>但像UV（UniqueVisitor，独立访客）、独立IP数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。</p>
<p>解决基数问题有很多种方案： （1）数据存储在MySQL表中，使用distinct count计算不重复个数 （2）使用Redis提供的hash、set、bitmaps等数据结构来处理</p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>能否能够降低一定的精度来平衡存储空间？Redis推出了HyperLogLog</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>什么是基数? 比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h3 id="2-2-常用命令-1"><a href="#2-2-常用命令-1" class="headerlink" title="2.2 常用命令"></a>2.2 常用命令</h3><blockquote>
<p> 1.pfadd </p>
</blockquote>
<p>添加指定元素到 HyperLogLog 中：</p>
<pre class="line-numbers language-none"><code class="language-none">pfadd key element element...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： <img src="https://img-blog.csdnimg.cn/20210424115310168.png" alt="在这里插入图片描述"> 将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
<blockquote>
<p> 2.pfcount </p>
</blockquote>
<p>计算HLL的近似基数，可以计算多个HLL，比如用HLL存储每天的UV，计算一周的UV可以使用7天的UV合并计算即可：</p>
<pre class="line-numbers language-none"><code class="language-none">pfcount key [key...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： <img src="https://img-blog.csdnimg.cn/20210424115623735.png" alt="在这里插入图片描述"></p>
<blockquote>
<p> 3.pfmerge </p>
</blockquote>
<p>将一个或多个HLL合并后的结果存储在另一个HLL中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得：</p>
<pre class="line-numbers language-none"><code class="language-none">pfmerge destkey sourcekey [sourcekey ...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： <img src="https://img-blog.csdnimg.cn/20210424115818258.png" alt="在这里插入图片描述"></p>
<h2 id="3-Geospatial"><a href="#3-Geospatial" class="headerlink" title="3.Geospatial"></a>3.Geospatial</h2><h3 id="3-1-简介-1"><a href="#3-1-简介-1" class="headerlink" title="3.1 简介"></a>3.1 简介</h3><p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h3 id="3-2-常用命令-1"><a href="#3-2-常用命令-1" class="headerlink" title="3.2 常用命令"></a>3.2 常用命令</h3><blockquote>
<p> 1.geoadd </p>
</blockquote>
<p>添加地理位置（经度，纬度，名称）：</p>
<pre class="line-numbers language-none"><code class="language-none">geoadd key longitude latitude member [longitude latitude member...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： geoadd china:city 121.47 31.23 shanghai geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen 116.38 39.90 beijing <img src="https://img-blog.csdnimg.cn/20210424120132226.png" alt="在这里插入图片描述"> 两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。 有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。 当坐标位置超出指定范围时，该命令将会返回一个错误。 已经添加的数据，是无法再次往里面添加的。</p>
<blockquote>
<p> 2.geopos </p>
</blockquote>
<p>获得指定地区的坐标值：</p>
<pre class="line-numbers language-none"><code class="language-none">geopos key member [member...]  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例： <img src="https://img-blog.csdnimg.cn/20210424120316724.png" alt="在这里插入图片描述"></p>
<blockquote>
<p> 3.geodist </p>
</blockquote>
<p>获取两个位置之间的直线距离：</p>
<pre class="line-numbers language-none"><code class="language-none">geodist key member1 member2 [m|km|ft|mi] <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实例：</p>
<p>获取两个位置之间的直线距离 <img src="https://img-blog.csdnimg.cn/20210424120655817.png" alt="在这里插入图片描述"> 单位： m 表示单位为米[默认值]。 km 表示单位为千米。 mi 表示单位为英里。 ft 表示单位为英尺。 如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>
<blockquote>
<p> 4.georadius </p>
</blockquote>
<p>以给定的经纬度为中心，找出某一半径内的元素：</p>
<pre class="line-numbers language-none"><code class="language-none">经度 纬度 距离 单位
georadius key longitude latitude radius  m|km|ft|mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>实例： <img src="https://img-blog.csdnimg.cn/20210424121014307.png" alt="在这里插入图片描述"></p>
<h1 id="八、Jedis测试"><a href="#八、Jedis测试" class="headerlink" title="八、Jedis测试"></a>八、Jedis测试</h1><h2 id="1-Jedis所需的jar包"><a href="#1-Jedis所需的jar包" class="headerlink" title="1.Jedis所需的jar包"></a>1.Jedis所需的jar包</h2><pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;
	&lt;groupId&gt;redis.clients&lt;/groupId&gt;
	&lt;artifactId&gt;jedis&lt;/artifactId&gt;
	&lt;version&gt;3.2.0&lt;/version&gt;
&lt;/dependency&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-连接Redis注意事项"><a href="#2-连接Redis注意事项" class="headerlink" title="2.连接Redis注意事项"></a>2.连接Redis注意事项</h2><p>禁用Linux的防火墙：Linux(CentOS7)里执行命令：</p>
<pre class="line-numbers language-none"><code class="language-none">systemctl stop/disable firewalld.service
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>redis.conf中注释掉<mark>bind 127.0.0.1</mark>，然后 <mark>protected-mode no</mark></p>
<h2 id="3-创建测试程序"><a href="#3-创建测试程序" class="headerlink" title="3.创建测试程序"></a>3.创建测试程序</h2><pre class="line-numbers language-none"><code class="language-none">package com.xu.jedis;

import redis.clients.jedis.Jedis;

public class JedisDemo1 {&lt;!-- --&gt;
    public static void main(String[] args) {&lt;!-- --&gt;
        //创建jedis对象
        Jedis jedis = new Jedis("192.168.50.128",6379);
        //连接redis的密码
        jedis.auth("root");
        //测试
        String value = jedis.ping();
        System.out.println(value);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-测试相关数据类型"><a href="#4-测试相关数据类型" class="headerlink" title="4.测试相关数据类型"></a>4.测试相关数据类型</h2><h3 id="4-1-Jedis-API：Key"><a href="#4-1-Jedis-API：Key" class="headerlink" title="4.1 Jedis-API：Key"></a>4.1 Jedis-API：Key</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k3"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Set</span><span class="token operator">&amp;</span>lt<span class="token punctuation">;</span><span class="token class-name">String</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> keys <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ttl</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-Jedis-API：String"><a href="#4-2-Jedis-API：String" class="headerlink" title="4.2 Jedis-API：String"></a>4.2 Jedis-API：String</h3><pre class="line-numbers language-none"><code class="language-none">jedis.mset("str1","v1","str2","v2","str3","v3");
System.out.println(jedis.mget("str1","str2","str3"));
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-3-Jedis-API：list"><a href="#4-3-Jedis-API：list" class="headerlink" title="4.3 Jedis-API：list"></a>4.3 Jedis-API：list</h3><pre class="line-numbers language-none"><code class="language-none">List&lt;String&gt; 
list = jedis.lrange("mylist",0,-1);
for (String element : list) {&lt;!-- --&gt;
	System.out.println(element);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-4-Jedis-API：set"><a href="#4-4-Jedis-API：set" class="headerlink" title="4.4 Jedis-API：set"></a>4.4 Jedis-API：set</h3><pre class="line-numbers language-none"><code class="language-none">jedis.sadd("orders", "order01");
jedis.sadd("orders", "order02");
jedis.sadd("orders", "order03");
jedis.sadd("orders", "order04");

Set&lt;String&gt; smembers = jedis.smembers("orders");

for (String order : smembers) {&lt;!-- --&gt;
	System.out.println(order);
}

jedis.srem("orders", "order02");
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-5-Jedis-API：hash"><a href="#4-5-Jedis-API：hash" class="headerlink" title="4.5 Jedis-API：hash"></a>4.5 Jedis-API：hash</h3><pre class="line-numbers language-none"><code class="language-none">jedis.hset("hash1","userName","lisi");
System.out.println(jedis.hget("hash1","userName"));

Map&lt;String,String&gt; map = new HashMap&lt;String,String&gt;();
map.put("telphone","13810169999");
map.put("address","atguigu");
map.put("email","abc@163.com");

jedis.hmset("hash2",map);

List&lt;String&gt; result = jedis.hmget("hash2", "telphone","email");

for (String element : result) {&lt;!-- --&gt;
	System.out.println(element);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-6-Jedis-API：zset"><a href="#4-6-Jedis-API：zset" class="headerlink" title="4.6 Jedis-API：zset"></a>4.6 Jedis-API：zset</h3><pre class="line-numbers language-none"><code class="language-none">jedis.zadd("zset01", 100d, "z3");
jedis.zadd("zset01", 90d, "l4");
jedis.zadd("zset01", 80d, "w5");
jedis.zadd("zset01", 70d, "z6");
 
Set&lt;String&gt; zrange = jedis.zrange("zset01", 0, -1);

for (String e : zrange) {&lt;!-- --&gt;
	System.out.println(e);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="九、Jedis实例：手机验证码功能"><a href="#九、Jedis实例：手机验证码功能" class="headerlink" title="九、Jedis实例：手机验证码功能"></a>九、Jedis实例：手机验证码功能</h1><blockquote>
<p>  要求：</p>
<p>  1、输入手机号，点击发送后随机生成6位数字码，2分钟有效 </p>
<p> 2、输入验证码，点击验证，返回成功或失败</p>
<p>  3、每个手机号每天只能输入3次 </p>
</blockquote>
<p>代码展示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jt<span class="token punctuation">.</span>jedis</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ICDM_王顺
 * @Classname PhoneCoide
 * @Description TODO
 * @Date 2021/11/26 11:16
 * @Created by TheKing_Shun
 */</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneCode</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//模拟验证码发送</span>
        <span class="token comment">//verifyCode("137000000");</span>

        <span class="token comment">//校验发送的验证码</span>
        <span class="token comment">//getRedisCode("137000000","验证码");</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//1.随即生成一个六位数的验证码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rand <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            code <span class="token operator">+=</span> rand<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//2.每个手机每天只能发送三次，验证码放到redis中，设置过期时间</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">verifyCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//连接redis</span>
            <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.50.128"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输入redis连接密码</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//拼接key</span>
        <span class="token comment">//手机发送次数key</span>
        <span class="token class-name">String</span> countKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":count"</span><span class="token punctuation">;</span>
        <span class="token comment">//验证码key</span>
        <span class="token class-name">String</span> codeKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":code"</span><span class="token punctuation">;</span>

        <span class="token comment">//每个手机每天只能发送3次</span>
        <span class="token class-name">String</span> count <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//没有发送次数，第一次发送</span>
                <span class="token comment">//设置发送次数是1</span>
                jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>countKey<span class="token punctuation">,</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//发送次数+1</span>
                jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span>countKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//发送三次了，不能再发送了</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"今天的发送次数已经超过3次了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//关闭连接</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//发送的验证码要放到redis中,设置过期时间为120s</span>
        <span class="token class-name">String</span> vcode <span class="token operator">=</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>codeKey<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span>vcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//3.验证码校验</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRedisCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//从redis中获取验证码</span>
            <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.50.128"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//验证码key</span>
        <span class="token class-name">String</span> codeKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":code"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> redisCode <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>codeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="十、Redis与SpringBoot整合"><a href="#十、Redis与SpringBoot整合" class="headerlink" title="十、Redis与SpringBoot整合"></a>十、Redis与SpringBoot整合</h1><p>Spring Boot整合Redis非常简单，只需要按如下步骤整合即可：</p>
<ol>
<li>在pom.xml文件中引入redis相关依赖<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--redis启动器--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--spring2.x 集成redis所需common-pool2--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>application.properties配置redis配置<pre class="line-numbers language-none"><code class="language-none">#Redis服务器地址
spring.redis.host=192.168.50.128
#Redis服务器连接端口
spring.redis.port=6379
#Redis数据库索引（默认为0）
spring.redis.database= 0
#连接超时时间（毫秒）
spring.redis.timeout=1800000
#连接池最大连接数（使用负值表示没有限制）
spring.redis.lettuce.pool.max-active=20
#最大阻塞等待时间(负数表示没限制)
spring.redis.lettuce.pool.max-wait=-1
#连接池中的最大空闲连接
spring.redis.lettuce.pool.max-idle=5
#连接池中的最小空闲连接
spring.redis.lettuce.pool.min-idle=0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>添加Redis配置类<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jt<span class="token punctuation">.</span>redis_springbooot<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonAutoDetect</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">CachingConfigurerSupport</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * @author ICDM_王顺
 * @Classname RedisConfig
 * @Description TODO
 * @Date 2021/11/26 13:54
 * @Created by TheKing_Shun
 */</span>

<span class="token comment">// @EnableCaching</span>
<span class="token comment">// @Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">CachingConfigurerSupport</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key序列化方式</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//value序列化</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//value hashmap序列化</span>
        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//解决查询缓存转换异常的问题</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>测试一下：RedisTestController中添加测试方法<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/redisTest"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestController</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token comment">// 这里推荐使用构造器方式</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">//设置值到redis</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"lucy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从redis获取值</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h1 id="十一、事务和锁机制"><a href="#十一、事务和锁机制" class="headerlink" title="十一、事务和锁机制"></a>十一、事务和锁机制</h1><h2 id="1-Redis的事务定义"><a href="#1-Redis的事务定义" class="headerlink" title="1.Redis的事务定义"></a>1.Redis的事务定义</h2><p>Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>
<p>Redis事务的主要作用就是<mark>串联多个命令</mark>防止别的命令插队。</p>
<h2 id="2-Multi、Exec、discard"><a href="#2-Multi、Exec、discard" class="headerlink" title="2.Multi、Exec、discard"></a>2.Multi、Exec、discard</h2><p>从输入Multi命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入Exec后，Redis会将之前的命令队列中的命令依次执行。</p>
<p>组队的过程中可以通过discard来放弃组队。 <img src="https://img-blog.csdnimg.cn/20210425191931365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>例如：</p>
<p>组队成功，提交成功：</p>
 <img src="https://img-blog.csdnimg.cn/20210425192039210.png" alt="在这里插入图片描述"> 

<p>组队阶段报错，提交失败：</p>
 <img src="https://img-blog.csdnimg.cn/20210425192150255.png" alt="在这里插入图片描述"> 

<p>组队成功，提交有成功也有失败：</p>
 <img src="https://img-blog.csdnimg.cn/20210425192339976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="3-事务的错误处理"><a href="#3-事务的错误处理" class="headerlink" title="3.事务的错误处理"></a>3.事务的错误处理</h2><blockquote>
<p> 组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消 <img src="https://img-blog.csdnimg.cn/2021042520002448.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p>
</blockquote>
<blockquote>
<p> 如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。 <img src="https://img-blog.csdnimg.cn/20210425200720110.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p>
</blockquote>
<h2 id="4-事务冲突问题"><a href="#4-事务冲突问题" class="headerlink" title="4.事务冲突问题"></a>4.事务冲突问题</h2><h3 id="4-1-例子"><a href="#4-1-例子" class="headerlink" title="4.1 例子"></a>4.1 例子</h3><blockquote>
<p> 一个请求想给金额减8000 一个请求想给金额减5000 一个请求想给金额减1000 </p>
</blockquote>
<img src="https://img-blog.csdnimg.cn/20210425200817386.png" alt="在这里插入图片描述">

<h3 id="4-2-悲观锁（解决事务冲突）"><a href="#4-2-悲观锁（解决事务冲突）" class="headerlink" title="4.2 悲观锁（解决事务冲突）"></a>4.2 悲观锁（解决事务冲突）</h3><img src="https://img-blog.csdnimg.cn/20210425201015606.png" alt="在这里插入图片描述"> 

<p><mark>悲观锁(Pessimistic Lock)</mark>，顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。<strong>传统的关系型数据库里边就用到了很多这种锁机制</strong>，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上<mark>锁</mark>。</p>
<h3 id="4-3-乐观锁（解决事务冲突）"><a href="#4-3-乐观锁（解决事务冲突）" class="headerlink" title="4.3 乐观锁（解决事务冲突）"></a>4.3 乐观锁（解决事务冲突）</h3><img src="https://img-blog.csdnimg.cn/20210425201118493.png" alt="在这里插入图片描述"> 

<p><mark>乐观锁(Optimistic Lock)</mark>，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。<mark>Redis就是利用这种check-and-set机制实现事务的</mark></p>
<h3 id="4-4-乐观锁在Redis中的具体使用"><a href="#4-4-乐观锁在Redis中的具体使用" class="headerlink" title="4.4 乐观锁在Redis中的具体使用"></a>4.4 乐观锁在Redis中的具体使用</h3><blockquote>
<p> watch key [key…] </p>
</blockquote>
<p>在执行multi之前，先执行watch key1 [key2],可以监视一个(或多个) key ，如果在事务<strong>执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断</strong>。 <img src="https://img-blog.csdnimg.cn/2021042520134180.png" alt="在这里插入图片描述"></p>
<blockquote>
<p> unwatch </p>
</blockquote>
<p>取消 WATCH 命令对所有 key 的监视。</p>
<p>如果在执行 WATCH 命令之后，EXEC 命令或DISCARD 命令先被执行了的话，那么就不需要再执行UNWATCH 了。</p>
<h2 id="5-Redis事务三大特性"><a href="#5-Redis事务三大特性" class="headerlink" title="5.Redis事务三大特性"></a>5.Redis事务三大特性</h2><ol>
<li> <mark>单独的隔离操作</mark>： 事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。 </li>
<li>   <mark>没有隔离级别的概念</mark>： 队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行 </li>
<li> <mark>不保证原子性</mark>： 事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚  <h1 id="十二、Redis持久化操作"><a href="#十二、Redis持久化操作" class="headerlink" title="十二、Redis持久化操作"></a>十二、Redis持久化操作</h1></li>
</ol>
<p>Redis 提供了2个不同形式的持久化方式。</p>
<ol>
<li>RDB（Redis DataBase）</li>
<li>AOF（Append Of File）<h2 id="1-RDB（Redis-DataBase）"><a href="#1-RDB（Redis-DataBase）" class="headerlink" title="1.RDB（Redis DataBase）"></a>1.RDB（Redis DataBase）</h2></li>
</ol>
<h3 id="1-1-RDB是什么"><a href="#1-1-RDB是什么" class="headerlink" title="1.1 RDB是什么"></a>1.1 RDB是什么</h3><p>==在指定的<strong>时间间隔</strong>内将内存中的数据集<strong>快照</strong>写入磁盘==， 也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里</p>
<h3 id="1-2-备份操作是如何进行的"><a href="#1-2-备份操作是如何进行的" class="headerlink" title="1.2 备份操作是如何进行的"></a>1.2 备份操作是如何进行的</h3><p>Redis会单独创建（fork）一个子进程来进行持久化，会<strong>先将数据写入到 一个临时文件中</strong>，待持久化过程都结束了，再用这个<strong>临时文件替换上次持久化</strong>好的文件。 整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是<mark>最后一次持久化后的数据可能丢失</mark>。</p>
<h3 id="1-3-Fork"><a href="#1-3-Fork" class="headerlink" title="1.3 Fork"></a>1.3 Fork</h3><ul>
<li>Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并<strong>作为原进程的子进程</strong>- 在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，Linux中引入了 “<strong>写时复制技术</strong>”- <strong>一般情况父进程和子进程会共用同一段物理内存</strong>，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。<h3 id="1-4-RDB持久化流程"><a href="#1-4-RDB持久化流程" class="headerlink" title="1.4 RDB持久化流程"></a>1.4 RDB持久化流程</h3></li>
</ul>
<img src="https://img-blog.csdnimg.cn/20210426152939153.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h3 id="1-5-dump-rdb文件"><a href="#1-5-dump-rdb文件" class="headerlink" title="1.5 dump.rdb文件"></a>1.5 dump.rdb文件</h3><p>在redis.conf中配置文件名称，默认为dump.rdb <img src="https://img-blog.csdnimg.cn/20210426153101274.png" alt="在这里插入图片描述"></p>
<h3 id="1-6-配置位置"><a href="#1-6-配置位置" class="headerlink" title="1.6 配置位置"></a>1.6 配置位置</h3><p>rdb文件的保存路径，也可以修改。默认为Redis启动时命令行所在的目录下</p>
<p>dir “/myredis/” <img src="https://img-blog.csdnimg.cn/20210426153208334.png" alt="在这里插入图片描述"></p>
<h3 id="1-7-如何触发RDB快照：保存策略"><a href="#1-7-如何触发RDB快照：保存策略" class="headerlink" title="1.7 如何触发RDB快照：保存策略"></a>1.7 如何触发RDB快照：保存策略</h3><h4 id="1-7-1-配置文件中默认的快照配置"><a href="#1-7-1-配置文件中默认的快照配置" class="headerlink" title="1.7.1 配置文件中默认的快照配置"></a>1.7.1 配置文件中默认的快照配置</h4><img src="https://img-blog.csdnimg.cn/20210426205545363.png" alt="在这里插入图片描述">

<h4 id="1-7-2-命令save-VS-bgsave"><a href="#1-7-2-命令save-VS-bgsave" class="headerlink" title="1.7.2 命令save VS bgsave"></a>1.7.2 命令save VS bgsave</h4><p>save ：save时只管保存，其它不管，全部阻塞。手动保存。不建议。</p>
<p>bgsave：Redis会在后台异步进行快照操作， 快照同时还可以响应客户端请求。</p>
<p>可以通过lastsave 命令获取最后一次成功执行快照的时间</p>
<h4 id="1-7-3-flushall命令"><a href="#1-7-3-flushall命令" class="headerlink" title="1.7.3 flushall命令"></a>1.7.3 flushall命令</h4><p>执行flushall命令，也会产生dump.rdb文件，但里面是空的，无意义</p>
<h4 id="1-7-4-Save"><a href="#1-7-4-Save" class="headerlink" title="1.7.4 Save"></a>1.7.4 Save</h4><p>格式：save 秒钟 写操作次数</p>
<p>RDB是整个内存的压缩过的Snapshot，RDB的数据结构，可以配置复合的快照触发条件</p>
<p>默认是1分钟内改了1万次，或5分钟内改了10次，或15分钟内改了1次。</p>
<p>禁用</p>
<p>不设置save指令，或者给save传入空字符串</p>
<h4 id="1-7-5-stop-writes-on-bgsave-error"><a href="#1-7-5-stop-writes-on-bgsave-error" class="headerlink" title="1.7.5 stop-writes-on-bgsave-error"></a>1.7.5 stop-writes-on-bgsave-error</h4><p><img src="https://img-blog.csdnimg.cn/2021042620580791.png" alt="在这里插入图片描述"> 当Redis无法写入磁盘的话，直接关掉Redis的写操作。推荐yes.</p>
<h4 id="1-7-6-rdbcompression-压缩文件"><a href="#1-7-6-rdbcompression-压缩文件" class="headerlink" title="1.7.6 rdbcompression 压缩文件"></a>1.7.6 rdbcompression 压缩文件</h4><p><img src="https://img-blog.csdnimg.cn/20210426205900150.png" alt="在这里插入图片描述"> 对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用<strong>LZF算法</strong>进行压缩。</p>
<p>如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能。推荐yes.</p>
<h4 id="1-7-7-rdbchecksum-检查完整性"><a href="#1-7-7-rdbchecksum-检查完整性" class="headerlink" title="1.7.7 rdbchecksum 检查完整性"></a>1.7.7 rdbchecksum 检查完整性</h4><p><img src="https://img-blog.csdnimg.cn/2021042620595429.png" alt="在这里插入图片描述"> 在存储快照后，还可以让redis使用CRC64算法来进行数据校验</p>
<p>但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能</p>
<p>推荐yes.</p>
<h4 id="1-7-8-rdb的备份"><a href="#1-7-8-rdb的备份" class="headerlink" title="1.7.8 rdb的备份"></a>1.7.8 rdb的备份</h4><p>先通过config get dir 查询rdb文件的目录</p>
<p>将*.rdb的文件拷贝到别的地方</p>
<p>rdb的恢复：</p>
<ul>
<li>关闭Redis- 先把备份的文件拷贝到工作目录下 cp dump2.rdb dump.rdb- 启动Redis, 备份数据会直接加载<h3 id="1-8-优势与劣势"><a href="#1-8-优势与劣势" class="headerlink" title="1.8 优势与劣势"></a>1.8 优势与劣势</h3></li>
</ul>
<p>优势：</p>
<ul>
<li>适合大规模的数据恢复- 对数据完整性和一致性要求不高更适合使用- 节省磁盘空间- 恢复速度快<img src="https://img-blog.csdnimg.cn/20210426153629616.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<p>劣势：</p>
<ul>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑- 虽然Redis在fork时使用了<strong>写时拷贝技术</strong>,但是如果数据庞大时还是比较消耗性能。- 在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。<h3 id="1-9-如何停止RDB"><a href="#1-9-如何停止RDB" class="headerlink" title="1.9 如何停止RDB"></a>1.9 如何停止RDB</h3></li>
</ul>
<p>动态停止RDB：redis-cli config set save “”#save后给空值，表示禁用保存策略</p>
<h3 id="1-10-RDB总结"><a href="#1-10-RDB总结" class="headerlink" title="1.10 RDB总结"></a>1.10 RDB总结</h3><img src="https://img-blog.csdnimg.cn/20210426153509145.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="2-AOF（Append-Only-File）"><a href="#2-AOF（Append-Only-File）" class="headerlink" title="2.AOF（Append Only File）"></a>2.AOF（Append Only File）</h2><h3 id="2-1-AOF是什么"><a href="#2-1-AOF是什么" class="headerlink" title="2.1 AOF是什么"></a>2.1 AOF是什么</h3><p><strong>以日志的形式来记录每个写操作（增量保存）</strong>，将Redis执行过的所有写指令记录下来(<strong>读操作不记录</strong>)， <strong>只许追加文件但不可以改写文件</strong>，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>
<h3 id="2-2-AOF持久化流程"><a href="#2-2-AOF持久化流程" class="headerlink" title="2.2 AOF持久化流程"></a>2.2 AOF持久化流程</h3><ol>
<li>客户端的请求写命令会被append追加到AOF缓冲区内；1. AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中；1. AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；1. Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的；<img src="https://img-blog.csdnimg.cn/20210426154302204.png" alt="在这里插入图片描述"></li>
</ol>
<h3 id="2-3-AOF默认不开启"><a href="#2-3-AOF默认不开启" class="headerlink" title="2.3 AOF默认不开启"></a>2.3 AOF默认不开启</h3><p>可以在redis.conf中配置文件名称，默认为 <strong>appendonly.aof</strong> AOF文件的保存路径，同RDB的路径一致。</p>
<h3 id="2-4-AOF和RDB同时开启，redis听谁的？"><a href="#2-4-AOF和RDB同时开启，redis听谁的？" class="headerlink" title="2.4 AOF和RDB同时开启，redis听谁的？"></a>2.4 AOF和RDB同时开启，redis听谁的？</h3><p>AOF和RDB同时开启，系统默认取<mark>AOF</mark>的数据（数据不会存在丢失）</p>
<h3 id="2-5-AOF启动-修复-恢复"><a href="#2-5-AOF启动-修复-恢复" class="headerlink" title="2.5 AOF启动/修复/恢复"></a>2.5 AOF启动/修复/恢复</h3><ul>
<li> AOF的备份机制和性能虽然和RDB不同, 但是备份和恢复的操作同RDB一样，都是拷贝备份文件，需要恢复时再拷贝到Redis工作目录下，启动系统即加载。 -  正常恢复 1.修改默认的appendonly no，改为yes 2.将有数据的aof文件复制一份保存到对应目录(查看目录：config get dir) 3.恢复：重启redis然后重新加载 -  异常恢复 1.修改默认的appendonly no，改为yes 2.如遇到AOF文件损坏，通过/usr/local/bin/redis-check-aof–fix appendonly.aof进行恢复 3.备份被写坏的AOF文件 4.恢复：重启redis，然后重新加载 <h3 id="2-6-AOF同步频率设置"><a href="#2-6-AOF同步频率设置" class="headerlink" title="2.6 AOF同步频率设置"></a>2.6 AOF同步频率设置</h3></li>
</ul>
<p>appendfsync always 始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</p>
<p>appendfsync everysec 每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p>
<p>appendfsync no redis不主动进行同步，把同步时机交给操作系统。</p>
<h3 id="2-7-Rewrite压缩"><a href="#2-7-Rewrite压缩" class="headerlink" title="2.7 Rewrite压缩"></a>2.7 Rewrite压缩</h3><ol>
<li><p>是什么：</p>
<blockquote>
<p>AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩， 只保留可以恢复数据的最小指令集.可以使用命令bgrewriteaof </p>
</blockquote>
</li>
<li><p>重写原理，如何实现重写</p>
<blockquote>
<p>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。 no-appendfsync-on-rewrite： 如果 no-appendfsync-on-rewrite=yes ,不写入aof文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能） 如果 no-appendfsync-on-rewrite=no, 还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低） 触发机制，何时重写 Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发 重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定Redis要满足一定条件才会进行重写。 auto-aof-rewrite-percentage：设置重写的基准值，文件达到100%时开始重写（文件是原来重写后文件的2倍时触发） auto-aof-rewrite-min-size：设置重写的基准值，最小文件64MB。达到这个值开始重写。 例如：文件达到70MB开始重写，降到50MB，下次什么时候开始重写？100MB 系统载入时或者上次重写完毕时，Redis会记录此时AOF大小，设为base_size, 如果Redis的AOF当前大小&gt;= base_size +base_size*100% (默认)且当前大小&gt;=64mb(默认)的情况下，Redis会对AOF进行重写。 </p>
</blockquote>
</li>
<li><p>重写流程</p>
<blockquote>
<p>（1）bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。 （2）主进程fork出子进程执行重写操作，保证主进程不会阻塞。 （3）子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入aof_buf缓冲区和aof_rewrite_buf重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。 （4）1).子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。2).主进程把aof_rewrite_buf中的数据写入到新的AOF文件。 （5）使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。 </p>
</blockquote>
</li>
</ol>
<img src="https://img-blog.csdnimg.cn/20210426161650968.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h3 id="2-8-优势与劣势"><a href="#2-8-优势与劣势" class="headerlink" title="2.8 优势与劣势"></a>2.8 优势与劣势</h3><p>优势： <img src="https://img-blog.csdnimg.cn/2021042616173976.png" alt="在这里插入图片描述"></p>
<ul>
<li>备份机制更稳健，丢失数据概率更低。- 可读的日志文本，通过操作AOF稳健，可以处理误操作。<br>劣势：</li>
<li>比起RDB占用更多的磁盘空间。- 恢复备份速度要慢。- 每次读写都同步的话，有一定的性能压力。- 存在个别Bug，造成恢复不能。</li>
</ul>
<p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111262201274.png" alt="image-20211126220134111"></p>
<h3 id="2-9-AOF总结"><a href="#2-9-AOF总结" class="headerlink" title="2.9 AOF总结"></a>2.9 AOF总结</h3><img src="https://img-blog.csdnimg.cn/20210426162218803.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><h3 id="3-1-选择哪个持久化方式"><a href="#3-1-选择哪个持久化方式" class="headerlink" title="3.1 选择哪个持久化方式"></a>3.1 选择哪个持久化方式</h3><p>官方推荐两个都启用。 如果对数据不敏感，可以选单独用RDB。 不建议单独用 AOF，因为可能会出现Bug。 如果只是做纯内存缓存，可以都不用。</p>
<h3 id="3-2-官方建议"><a href="#3-2-官方建议" class="headerlink" title="3.2 官方建议"></a>3.2 官方建议</h3><ul>
<li>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储- AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.- Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大- 只做缓存：如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.- 同时开启两种持久化方式- 在这种情况下,当redis重启的时候会优先载入AOF文件来恢复原始的数据, 因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.- RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？- 建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)， 快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。- 性能建议：<blockquote>
<p>因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。 如果使用AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。 代价,一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。 只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。 默认超过原大小100%大小时重写可以改到适当的数值。 </p>
</blockquote>
</li>
</ul>
<h1 id="十三、Redis主从复制"><a href="#十三、Redis主从复制" class="headerlink" title="十三、Redis主从复制"></a>十三、Redis主从复制</h1><h2 id="1-是什么"><a href="#1-是什么" class="headerlink" title="1.是什么"></a>1.是什么</h2><p>主机数据更新后根据配置和策略， 自动同步到备机的<mark>master/slaver机制，Master以写为主，Slave以读为主</mark></p>
<h2 id="2-能干嘛"><a href="#2-能干嘛" class="headerlink" title="2.能干嘛"></a>2.能干嘛</h2><ul>
<li>读写分离，性能扩展- </li>
<li>容灾快速恢复<img src="https://img-blog.csdnimg.cn/20210426165108108.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<h2 id="3-具体操作：主从复制"><a href="#3-具体操作：主从复制" class="headerlink" title="3.具体操作：主从复制"></a>3.具体操作：主从复制</h2><blockquote>
<p>  拷贝多个redis.conf文件</p>
<p> include(写绝对路径)  引入公共配置</p>
<p> 开启daemonize yes </p>
<p> Pid文件名字pidfile</p>
<p>  指定端口port</p>
<p>  Log文件名字</p>
<p>  dump.rdb名字</p>
<p> dbfilename Appendonly 关掉或者换名字 </p>
<p> <img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111262215782.png" alt="image-20211126221539621"></p>
</blockquote>
<h3 id="3-1-新建redis6379-conf，填写以下内容"><a href="#3-1-新建redis6379-conf，填写以下内容" class="headerlink" title="3.1 新建redis6379.conf，填写以下内容"></a>3.1 新建redis6379.conf，填写以下内容</h3><img src="https://img-blog.csdnimg.cn/20210426171031960.png" alt="在这里插入图片描述">

<h3 id="3-2-新建redis6380-conf，填写以下内容"><a href="#3-2-新建redis6380-conf，填写以下内容" class="headerlink" title="3.2 新建redis6380.conf，填写以下内容"></a>3.2 新建redis6380.conf，填写以下内容</h3><img src="https://img-blog.csdnimg.cn/20210426171046531.png" alt="在这里插入图片描述">

<h3 id="3-3-新建redis6381-conf，填写以下内容"><a href="#3-3-新建redis6381-conf，填写以下内容" class="headerlink" title="3.3 新建redis6381.conf，填写以下内容"></a>3.3 新建redis6381.conf，填写以下内容</h3><img src="https://img-blog.csdnimg.cn/20210426171052487.png" alt="在这里插入图片描述"> 

<p><mark>slave-priority 10</mark></p>
<p>设置从机的优先级，值越小，优先级越高，用于选举主机时使用。默认100</p>
<h3 id="3-4-启动三台Redis服务器"><a href="#3-4-启动三台Redis服务器" class="headerlink" title="3.4 启动三台Redis服务器"></a>3.4 启动三台Redis服务器</h3><img src="https://img-blog.csdnimg.cn/20210426174552329.png" alt="在这里插入图片描述">

<h3 id="3-5-查看系统进程，看看三台服务器是否启动"><a href="#3-5-查看系统进程，看看三台服务器是否启动" class="headerlink" title="3.5 查看系统进程，看看三台服务器是否启动"></a>3.5 查看系统进程，看看三台服务器是否启动</h3><img src="https://img-blog.csdnimg.cn/20210426174615910.png" alt="在这里插入图片描述">

<h3 id="3-6-查看三台主机运行情况"><a href="#3-6-查看三台主机运行情况" class="headerlink" title="3.6 查看三台主机运行情况"></a>3.6 查看三台主机运行情况</h3><p>==info replication== 打印主从复制的相关信息 <img src="https://img-blog.csdnimg.cn/20210426174720657.png" alt="在这里插入图片描述"></p>
<h3 id="3-7-配从-库-不配主-库"><a href="#3-7-配从-库-不配主-库" class="headerlink" title="3.7 配从(库)不配主(库)"></a>3.7 配从(库)不配主(库)</h3><p>slaveof ip port 成为某个实例的从服务器</p>
<ol>
<li><p>在6380和6381上执行: slaveof 127.0.0.1 6379 <img src="https://img-blog.csdnimg.cn/2021042617491128.png" alt="在这里插入图片描述"></p>
</li>
<li><ol>
<li><p>在主机上写，在从机上可以读取数据 在从机上写数据报错 <img src="https://img-blog.csdnimg.cn/20210426174926870.png" alt="在这里插入图片描述"></p>
</li>
<li><ol>
<li><p>主机挂掉，重启就行，一切如初1. 从机重启需重设：slaveof 127.0.0.1 6379 可以将配置增加到文件中。永久生效。</p>
 <img src="https://img-blog.csdnimg.cn/20210426174952984.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
## 4.常用三招</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="4-1-一主二仆"><a href="#4-1-一主二仆" class="headerlink" title="4.1 一主二仆"></a>4.1 一主二仆</h3><p>切入点问题？slave1、slave2是从头开始复制还是从切入点开始复制?比如从k4进来，那之前的k1,k2,k3是否也可以复制？</p>
<p>从机是否可以写？set可否？</p>
<p>主机shutdown后情况如何？从机是上位还是原地待命？</p>
<p>主机又回来了后，主机新增记录，从机还能否顺利复制？</p>
<p>其中一台从机down后情况如何？依照原有它能跟上大部队吗？</p>
<img src="https://img-blog.csdnimg.cn/20210426181309495.png" alt="在这里插入图片描述">

<h3 id="4-2-薪火相传"><a href="#4-2-薪火相传" class="headerlink" title="4.2 薪火相传"></a>4.2 薪火相传</h3><p>上一个Slave可以是下一个slave的Master，Slave同样可以接收其他 slaves的连接和同步请求，那么该slave作为了链条中下一个的master, 可以有效减轻master的写压力,去中心化降低风险。</p>
<p>用 slaveof ip port 中途变更转向:会清除之前的数据，重新建立拷贝最新的 风险是一旦某个slave宕机，后面的slave都没法备份 主机挂了，从机还是从机，无法写数据了</p>
<p><img src="https://img-blog.csdnimg.cn/20210426181423809.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210426181433721.png" alt="在这里插入图片描述"></p>
<h3 id="4-3-反客为主"><a href="#4-3-反客为主" class="headerlink" title="4.3 反客为主"></a>4.3 反客为主</h3><p>当一个master宕机后，后面的slave可以立刻升为master，其后面的slave不用做任何修改。</p>
<p>用 slaveof no one 将从机变为主机。 <img src="https://img-blog.csdnimg.cn/20210426181506400.png" alt="在这里插入图片描述"></p>
<h2 id="5-复制原理"><a href="#5-复制原理" class="headerlink" title="5.复制原理"></a>5.复制原理</h2><ul>
<li>Slave启动成功连接到master后会发送一个sync命令- Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master将传送整个数据文件到slave,以完成一次完全同步-</li>
<li> 全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。- </li>
<li>增量复制：Master继续将新的所有收集到的修改命令依次传给slave,完成同步- 但是只要是重新连接master,一次完全同步（全量复制)将被自动执行<br><img src="https://img-blog.csdnimg.cn/20210426181626693.png" alt="在这里插入图片描述"><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111262224024.png" alt="image-20211126222426844"></li>
</ul>
<h2 id="6-哨兵模式-sentinel"><a href="#6-哨兵模式-sentinel" class="headerlink" title="6.哨兵模式(sentinel)"></a>6.哨兵模式(sentinel)</h2><h3 id="6-1-是什么"><a href="#6-1-是什么" class="headerlink" title="6.1 是什么"></a>6.1 是什么</h3><p><strong>反客为主的自动版</strong>，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库</p>
<img src="https://img-blog.csdnimg.cn/20210426181732246.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h3 id="6-2-操作步骤"><a href="#6-2-操作步骤" class="headerlink" title="6.2 操作步骤"></a>6.2 操作步骤</h3><h4 id="6-2-1-调整为一主二仆模式，6379带着6380、6381"><a href="#6-2-1-调整为一主二仆模式，6379带着6380、6381" class="headerlink" title="6.2.1 调整为一主二仆模式，6379带着6380、6381"></a>6.2.1 调整为一主二仆模式，6379带着6380、6381</h4><img src="https://img-blog.csdnimg.cn/20210427153756815.png" alt="在这里插入图片描述" style="zoom:150%;">

<h4 id="6-2-2-创建sentinel-conf文件"><a href="#6-2-2-创建sentinel-conf文件" class="headerlink" title="6.2.2 创建sentinel.conf文件"></a>6.2.2 创建sentinel.conf文件</h4><p>自定义的/myredis目录下新建sentinel.conf文件，名字绝不能错</p>
<h4 id="6-2-3-配置哨兵-填写内容"><a href="#6-2-3-配置哨兵-填写内容" class="headerlink" title="6.2.3 配置哨兵,填写内容"></a>6.2.3 配置哨兵,填写内容</h4><p>sentinel monitor mymaster 127.0.0.1 6379 1</p>
<p>其中mymaster为监控对象起的服务器名称， ==1 为至少有多少个哨兵同意迁移的数量。==</p>
<h4 id="6-2-4-启动哨兵"><a href="#6-2-4-启动哨兵" class="headerlink" title="6.2.4 启动哨兵"></a>6.2.4 启动哨兵</h4><p>/usr/local/bin</p>
<p>redis做压测可以用自带的redis-benchmark工具</p>
<p>执行redis-sentinel /myredis/sentinel.conf <img src="https://img-blog.csdnimg.cn/20210427153958757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="6-2-5-当主机挂掉，从机选举中产生新的主机"><a href="#6-2-5-当主机挂掉，从机选举中产生新的主机" class="headerlink" title="6.2.5 当主机挂掉，从机选举中产生新的主机"></a>6.2.5 当主机挂掉，从机选举中产生新的主机</h4><p>(大概10秒左右可以看到哨兵窗口日志，切换了新的主机)</p>
<p>哪个从机会被选举为主机呢？根据优先级别：<strong>slave-priority</strong></p>
<p>原主机重启后会变为从机</p>
 <img src="https://img-blog.csdnimg.cn/20210427154038884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h4 id="6-2-6-复制延时"><a href="#6-2-6-复制延时" class="headerlink" title="6.2.6 复制延时"></a>6.2.6 复制延时</h4><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p>
<h3 id="6-3-故障恢复"><a href="#6-3-故障恢复" class="headerlink" title="6.3 故障恢复"></a>6.3 故障恢复</h3><p><img src="https://img-blog.csdnimg.cn/20210426181808424.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 优先级在redis.conf中默认：replica-priority100，==值越小优先级越高==</p>
<p>偏移量是指获得原主机数据最全的</p>
<p>每个redis实例启动后都会随机生成一个40位的runid</p>
<h1 id="十四、Redis集群"><a href="#十四、Redis集群" class="headerlink" title="十四、Redis集群"></a>十四、Redis集群</h1><h2 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h2><p>容量不够，redis如何进行扩容？</p>
<p>并发写操作， redis如何分摊？</p>
<p><strong>另外，主从模式，薪火相传模式，主机宕机，导致ip地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息</strong>。</p>
<p>之前通过代理主机来解决，但是<strong>redis3.0</strong>中提供了解决方案。就是<strong>无中心化集群</strong>配置。</p>
<h2 id="2-什么是集群"><a href="#2-什么是集群" class="headerlink" title="2.什么是集群"></a>2.什么是集群</h2><p>Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1/N。</p>
<p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>
<h2 id="3-删除持久化数据"><a href="#3-删除持久化数据" class="headerlink" title="3.删除持久化数据"></a>3.删除持久化数据</h2><p>将rdb,aof文件都删除掉！</p>
<h2 id="4-制作6个实例"><a href="#4-制作6个实例" class="headerlink" title="4.制作6个实例"></a>4.制作6个实例</h2><h3 id="4-1-配置基本信息"><a href="#4-1-配置基本信息" class="headerlink" title="4.1 配置基本信息"></a>4.1 配置基本信息</h3><p>开启daemonize yes Pid文件名字 指定端口 Log文件名字 Dump.rdb名字 Appendonly 关掉或者换名字</p>
<h3 id="4-2-redis-cluster配置修改"><a href="#4-2-redis-cluster配置修改" class="headerlink" title="4.2 redis cluster配置修改"></a>4.2 redis cluster配置修改</h3><p>cluster-enabled yes 打开集群模式</p>
<p>cluster-config-file nodes-6379.conf 设定节点配置文件名</p>
<p>cluster-node-timeout 15000 设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</p>
<blockquote>
<p> include /home/bigdata/redis.conf port 6379 pidfile “/var/run/redis_6379.pid” dbfilename “dump6379.rdb” dir “/home/bigdata/redis_cluster” logfile “/home/bigdata/redis_cluster/redis_err_6379.log” cluster-enabled yes cluster-config-file nodes-6379.conf cluster-node-timeout 15000 </p>
</blockquote>
<h3 id="4-3-修改好redis6379-conf文件，拷贝多个redis-conf文件"><a href="#4-3-修改好redis6379-conf文件，拷贝多个redis-conf文件" class="headerlink" title="4.3 修改好redis6379.conf文件，拷贝多个redis.conf文件"></a>4.3 修改好redis6379.conf文件，拷贝多个redis.conf文件</h3><img src="https://img-blog.csdnimg.cn/20210427162617895.png" alt="在这里插入图片描述">

<h3 id="4-4-使用查找替换修改另外5个文件"><a href="#4-4-使用查找替换修改另外5个文件" class="headerlink" title="4.4 使用查找替换修改另外5个文件"></a>4.4 使用查找替换修改另外5个文件</h3><p>例如：:%s/6379/6380</p>
<h3 id="4-5-启动6个redis服务"><a href="#4-5-启动6个redis服务" class="headerlink" title="4.5 启动6个redis服务"></a>4.5 启动6个redis服务</h3><img src="https://img-blog.csdnimg.cn/20210427162713623.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<h2 id="5-将6个节点合成一个集群"><a href="#5-将6个节点合成一个集群" class="headerlink" title="5.将6个节点合成一个集群"></a>5.将6个节点合成一个集群</h2><p>组合之前，请确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</p>
<img src="https://img-blog.csdnimg.cn/20210427162748500.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<p>合体： cd /opt/redis-6.2.1/src</p>
<blockquote>
<p> redis-cli –cluster create –cluster-replicas 1 192.168.11.101:6379 192.168.11.101:6380 192.168.11.101:6381 192.168.11.101:6389 192.168.11.101:6390 192.168.11.101:6391 </p>
</blockquote>
<p>此处不要用127.0.0.1， 请用真实IP地址 –replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。 <img src="https://img-blog.csdnimg.cn/20210427162839874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210427162857653.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>普通方式登录： 可能直接进入读主机，存储数据时，会出现MOVED重定向操作。所以，应该以集群方式登录。 <img src="https://img-blog.csdnimg.cn/20210427162958321.png" alt="在这里插入图片描述"></p>
<h2 id="6-c-采用集群策略连接，设置数据会自动切换到相应的写主机"><a href="#6-c-采用集群策略连接，设置数据会自动切换到相应的写主机" class="headerlink" title="6.-c 采用集群策略连接，设置数据会自动切换到相应的写主机"></a>6.-c 采用集群策略连接，设置数据会自动切换到相应的写主机</h2><img src="https://img-blog.csdnimg.cn/20210427163051611.png" alt="在这里插入图片描述">

<h2 id="7-通过-cluster-nodes-命令查看集群信息"><a href="#7-通过-cluster-nodes-命令查看集群信息" class="headerlink" title="7.通过 cluster nodes 命令查看集群信息"></a>7.通过 cluster nodes 命令查看集群信息</h2><img src="https://img-blog.csdnimg.cn/20210427163106937.png" alt="在这里插入图片描述">

<h2 id="8-redis-cluster-如何分配这六个节点"><a href="#8-redis-cluster-如何分配这六个节点" class="headerlink" title="8.redis cluster 如何分配这六个节点"></a>8.redis cluster 如何分配这六个节点</h2><p>一个集群至少要有<strong>三个主节点</strong>。</p>
<p>选项 –cluster-replicas 1 表示我们希望为集群中的每个+主节点创建一个从节点。</p>
<p>==分配原则尽量保证每个主数据库运行在不同的IP地址，每个从库和主库不在一个IP地址上。==</p>
<p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111271047381.png" alt="image-20211127104720231"></p>
<h2 id="9-什么是slots"><a href="#9-什么是slots" class="headerlink" title="9.什么是slots"></a>9.什么是slots</h2><blockquote>
<p> [OK] All nodes agree about slots configuration. Check for open slots… Check slots coverage… [OK] All 16384 slots covered. </p>
</blockquote>
<p>一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个</p>
<p>集群使用公式 CRC16(key) % 16384(2^14) 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</p>
<p>集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中： 节点 A 负责处理 0 号至 5460 号插槽。 节点 B 负责处理 5461 号至 10922 号插槽。 节点 C 负责处理 10923 号至 16383 号插槽。</p>
<h2 id="10-在集群中录入值"><a href="#10-在集群中录入值" class="headerlink" title="10.在集群中录入值"></a>10.在集群中录入值</h2><p>在redis-cli每次录入、查询键值，redis都会计算出该key应该送往的插槽，如果不是该客户端对应服务器的插槽，redis会报错，并告知应前往的redis实例地址和端口。</p>
<p>redis-cli客户端提供了 –c 参数实现自动重定向。</p>
<p>如 redis-cli -c –p 6379 登入后，再录入、查询键值对可以自动重定向。</p>
<p>不在一个slot下的键值，是不能使用mget,mset等多键操作。 <img src="https://img-blog.csdnimg.cn/2021042716511679.png" alt="在这里插入图片描述"></p>
<p>可以通过{}来定义组的概念，从而使key中{}内相同内容的键值对放到一个slot中去。 <img src="https://img-blog.csdnimg.cn/20210427165130868.png" alt="在这里插入图片描述"></p>
<h2 id="11-查询集群中的值"><a href="#11-查询集群中的值" class="headerlink" title="11.查询集群中的值"></a>11.查询集群中的值</h2><p>CLUSTER GETKEYSINSLOT slot count 返回 count 个 slot 槽中的键。 <img src="https://img-blog.csdnimg.cn/20210427165218846.png" alt="在这里插入图片描述"></p>
<h2 id="12-故障恢复"><a href="#12-故障恢复" class="headerlink" title="12.故障恢复"></a>12.故障恢复</h2><p>如果主节点下线？从节点能否自动升为主节点？注意：<strong>15秒超时</strong> </p>
<img src="https://img-blog.csdnimg.cn/20210427165237232.png" alt="在这里插入图片描述"> 

<p>主节点恢复后，主从关系会如何？主节点回来变成从机。 <img src="https://img-blog.csdnimg.cn/20210427165248918.png" alt="在这里插入图片描述"> </p>
<p>如果所有某一段插槽的主从节点都宕掉，redis服务是否还能继续?</p>
<p>如果某一段插槽的主从都挂掉，而==cluster-require-full-coverage== 为==yes== ，那么 ，整个集群都挂掉</p>
<p>如果某一段插槽的主从都挂掉，而==cluster-require-full-coverage== 为==no== ，那么，该插槽数据全都不能使用，也无法存储。</p>
<p>redis.conf中的参数 cluster-require-full-coverage</p>
<h2 id="13-集群的Jedis开发"><a href="#13-集群的Jedis开发" class="headerlink" title="13.集群的Jedis开发"></a>13.集群的Jedis开发</h2><p>即使连接的不是主机，集群会自动切换主机存储。主机写，从机读。 无中心化主从集群。无论从哪台主机写的数据，其他主机上都能读到数据。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 可以用set 或者直接使用JedisCluster jedisCluster=new JedisCluster(new HostAndPort("192.168.31.211",6379));</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisClusterTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span>set <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.31.211"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JedisCluster</span> jedisCluster<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisCluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedisCluster<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="14-Redis-集群的好处与不足"><a href="#14-Redis-集群的好处与不足" class="headerlink" title="14.Redis 集群的好处与不足"></a>14.Redis 集群的好处与不足</h2><blockquote>
<p> 好处 </p>
</blockquote>
<ul>
<li>==实现扩====容==- ==分摊压力==- ==无中心配置相对简单==<blockquote>
<p>不足 </p>
</blockquote>
</li>
</ul>
<p>==多键操作是不被支持的==</p>
<p>多键的Redis事务是不被支持的。lua脚本不被支持</p>
<p>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要==迁移至redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。==</p>
<h1 id="十五、Redis应用问题解决"><a href="#十五、Redis应用问题解决" class="headerlink" title="十五、Redis应用问题解决"></a>十五、Redis应用问题解决</h1><h2 id="1-缓存穿透"><a href="#1-缓存穿透" class="headerlink" title="1.缓存穿透"></a>1.缓存穿透</h2><h3 id="1-1-问题描述"><a href="#1-1-问题描述" class="headerlink" title="1.1 问题描述"></a>1.1 问题描述</h3><p>key对应的数据在数据源并不存在，每次针对此key的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据源。比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。 <img src="https://img-blog.csdnimg.cn/20210426183724212.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111271106211.png" alt="image-20211127110625070"></p>
<h3 id="1-2-解决方案"><a href="#1-2-解决方案" class="headerlink" title="1.2 解决方案"></a>1.2 解决方案</h3><p>一个一定不存在缓存及查询不到的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</p>
<p>解决方案： </p>
<p>（1） ==对空值缓存==：如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间会很短，最长不超过五分钟 </p>
<p>（2） ==设置可访问的名单==（白名单）： 使用bitmaps类型定义一个可以访问的名单，名单id作为bitmaps的偏移量，每次访问和bitmap里面的id进行比较，如果访问id不在bitmaps里面，进行拦截，不允许访问。 </p>
<p>（3） ==采用布隆过滤器==：(布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量(位图)和一系列随机映射函数（哈希函数）。 布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。) 将所有可能存在的数据哈希到一个足够大的bitmaps中，一个一定不存在的数据会被 这个bitmaps拦截掉，从而避免了对底层存储系统的查询压力。 </p>
<p>（4） ==进行实时监控==：当发现Redis的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设置黑名单限制服务</p>
<h2 id="2-缓存击穿"><a href="#2-缓存击穿" class="headerlink" title="2.缓存击穿"></a>2.缓存击穿</h2><h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p>key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<img src="https://img-blog.csdnimg.cn/20210427165625892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111271110835.png" alt="image-20211127111034716"></p>
<h3 id="2-2-解决方案"><a href="#2-2-解决方案" class="headerlink" title="2.2 解决方案"></a>2.2 解决方案</h3><p>key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题。 ==解决问题：== </p>
<p>（1）==预先设置热门数据：==在redis高峰访问之前，把一些热门数据提前存入到redis里面，加大这些热门数据key的时长 </p>
<p>（2）==实时调整==：现场监控哪些数据热门，实时调整key的过期时长 </p>
<p>（3）==使用锁==：</p>
<ol>
<li>就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db。1. 先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX）去set一个mutex key1. 当操作返回成功时，再进行load db的操作，并回设缓存,最后删除mutex key；1. 当操作返回失败，证明有线程在load db，当前线程睡眠一段时间再重试整个get缓存的方法。<img src="https://img-blog.csdnimg.cn/20210427165735913.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ol>
<h2 id="3-缓存雪崩"><a href="#3-缓存雪崩" class="headerlink" title="3.缓存雪崩"></a>3.缓存雪崩</h2><h3 id="3-1-问题描述"><a href="#3-1-问题描述" class="headerlink" title="3.1 问题描述"></a>3.1 问题描述</h3><p>key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。 缓存雪崩与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key</p>
<p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111271113805.png" alt="image-20211127111312693"></p>
<p>正常访问： <img src="https://img-blog.csdnimg.cn/20210427165942327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>缓存失效瞬间： <img src="https://img-blog.csdnimg.cn/20210427170340325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="3-2-解决方案"><a href="#3-2-解决方案" class="headerlink" title="3.2 解决方案"></a>3.2 解决方案</h3><p>缓存失效时的雪崩效应对底层系统的冲击非常可怕！</p>
<p>解决方案： </p>
<p>（1） ==构建多级缓存架构==：nginx缓存 + redis缓存 +其他缓存（ehcache等） </p>
<p>（2） ==使用锁或队列==： 用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。不适用高并发情况 </p>
<p>（3） ==设置过期标志更新缓存==： 记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际key的缓存。 </p>
<p>（4） ==将缓存失效时间分散开==： 比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
<h2 id="4-分布式锁"><a href="#4-分布式锁" class="headerlink" title="4.分布式锁"></a>4.分布式锁</h2><h3 id="4-1-问题描述"><a href="#4-1-问题描述" class="headerlink" title="4.1 问题描述"></a>4.1 问题描述</h3><p>随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的Java API并不能提供分布式锁的能力。为了解决这个问题就需要一种跨JVM的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题！</p>
<p>分布式锁主流的实现方案：</p>
<ol>
<li>基于数据库实现分布式锁1. 基于缓存（Redis等）1. 基于Zookeeper 每一种分布式锁解决方案都有各自的优缺点：1. 性能：redis最高1. 可靠性：zookeeper最高<br>这里，我们就基于redis实现分布式锁。</li>
</ol>
<h3 id="4-2-解决方案：使用redis实现分布式锁"><a href="#4-2-解决方案：使用redis实现分布式锁" class="headerlink" title="4.2 解决方案：使用redis实现分布式锁"></a>4.2 解决方案：使用redis实现分布式锁</h3><p><img src="https://gitee.com/ICDM_ws/pic-bed/raw/master/all/202111271122292.png" alt="image-20211127112209152"></p>
<p>redis : 命令</p>
<p>set sku:1:info “OK” NX PX 10000</p>
<p>EX second ：设置键的过期时间为 second 秒。 SET key value EX second 效果等同于 SETEX key second value 。</p>
<p>PX millisecond ：设置键的过期时间为 millisecond 毫秒。 SET key value PX millisecond 效果等同于 PSETEX key millisecond value 。</p>
<p>NX ：只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。</p>
<p>XX ：只在键已经存在时，才对键进行设置操作。</p>
<img src="https://img-blog.csdnimg.cn/20210427170843840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
1. 多个客户端同时获取锁（setnx）1. 获取成功，执行业务逻辑{从db获取数据，放入缓存}，执行完成释放锁（del）1. 其他客户端等待重试
### 4.3 编写代码

<p>Redis: set num 0</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"testLock"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1获取锁，setne</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2获取锁成功、查询num的值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.1判断num为空return</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2.2有值就转成成int</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.3把redis的num加1</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span> <span class="token operator">++</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.4释放锁，del</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">//3获取锁失败、每隔0.1秒再获取</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">testLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重启，服务集群，通过网关压力测试： ab -n 1000 -c 100 <a target="_blank" rel="noopener" href="http://192.168.140.1:8080/test/testLock">http://192.168.140.1:8080/test/testLock</a></p>
<img src="https://img-blog.csdnimg.cn/2021042717112672.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<p>查看redis中num的值： <img src="https://img-blog.csdnimg.cn/20210427171142388.png" alt="在这里插入图片描述"> </p>
<p>基本实现。 问题：setnx刚好获取到锁，业务逻辑出现异常，导致锁无法释放 解决：设置过期时间，自动释放锁。</p>
<h3 id="4-4-优化之设置锁的过期时间"><a href="#4-4-优化之设置锁的过期时间" class="headerlink" title="4.4 优化之设置锁的过期时间"></a>4.4 优化之设置锁的过期时间</h3><p>设置过期时间有两种方式：</p>
<ol>
<li>首先想到通过expire设置过期时间（缺乏原子性：如果在setnx和expire之间出现异常，锁也无法释放）1. 在set时指定过期时间（推荐）<br><img src="https://img-blog.csdnimg.cn/20210427171218156.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 设置过期时间： <img src="https://img-blog.csdnimg.cn/20210427171301126.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ol>
<p>压力测试肯定也没有问题。自行测试 问题：可能会释放其他服务器的锁。</p>
<p>场景：如果业务逻辑的执行时间是7s。执行流程如下</p>
<ol>
<li>index1业务逻辑没执行完，3秒后锁被自动释放。1. index2获取到锁，执行业务逻辑，3秒后锁被自动释放。1. index3获取到锁，执行业务逻辑1. index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，导致index3的业务只执行1s就被别人释放。 最终等于没锁的情况。<br>解决：setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁</li>
</ol>
<h3 id="4-5-优化之UUID防误删"><a href="#4-5-优化之UUID防误删" class="headerlink" title="4.5 优化之UUID防误删"></a>4.5 优化之UUID防误删</h3><img src="https://img-blog.csdnimg.cn/20210427171340643.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<img src="https://img-blog.csdnimg.cn/20210427171350165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">

<p>问题：删除操作缺乏原子性。 场景： <img src="https://img-blog.csdnimg.cn/20210427171437640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="4-6-优化之LUA脚本保证删除的原子性"><a href="#4-6-优化之LUA脚本保证删除的原子性" class="headerlink" title="4.6 优化之LUA脚本保证删除的原子性"></a>4.6 优化之LUA脚本保证删除的原子性</h3><pre class="line-numbers language-none"><code class="language-none">@GetMapping("testLockLua")
public void testLockLua() {&lt;!-- --&gt;
    //1 声明一个uuid ,将做为一个value 放入我们的key所对应的值中
    String uuid = UUID.randomUUID().toString();
    //2 定义一个锁：lua 脚本可以使用同一把锁，来实现删除！
    String skuId = "25"; // 访问skuId 为25号的商品 100008348542
    String locKey = "lock:" + skuId; // 锁住的是每个商品的数据

    // 3 获取锁
    Boolean lock = redisTemplate.opsForValue().setIfAbsent(locKey, uuid, 3, TimeUnit.SECONDS);

    // 第一种： lock 与过期时间中间不写任何的代码。
    // redisTemplate.expire("lock",10, TimeUnit.SECONDS);//设置过期时间
    // 如果true
    if (lock) {&lt;!-- --&gt;
        // 执行的业务逻辑开始
        // 获取缓存中的num 数据
        Object value = redisTemplate.opsForValue().get("num");
        // 如果是空直接返回
        if (StringUtils.isEmpty(value)) {&lt;!-- --&gt;
            return;
        }
        // 不是空 如果说在这出现了异常！ 那么delete 就删除失败！ 也就是说锁永远存在！
        int num = Integer.parseInt(value + "");
        // 使num 每次+1 放入缓存
        redisTemplate.opsForValue().set("num", String.valueOf(++num));
        /*使用lua脚本来锁*/
        // 定义lua 脚本
        String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end";
        // 使用redis执行lua执行
        DefaultRedisScript&lt;Long&gt; redisScript = new DefaultRedisScript&lt;&gt;();
        redisScript.setScriptText(script);
        // 设置一下返回值类型 为Long
        // 因为删除判断的时候，返回的0,给其封装为数据类型。如果不封装那么默认返回String 类型，
        // 那么返回字符串与0 会有发生错误。
        redisScript.setResultType(Long.class);
        // 第一个要是script 脚本 ，第二个需要判断的key，第三个就是key所对应的值。
        redisTemplate.execute(redisScript, Arrays.asList(locKey), uuid);
    } else {&lt;!-- --&gt;
        // 其他线程等待
        try {&lt;!-- --&gt;
            // 睡眠
            Thread.sleep(1000);
            // 睡醒了之后，调用方法。
            testLockLua();
        } catch (InterruptedException e) {&lt;!-- --&gt;
            e.printStackTrace();
        }
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Lua 脚本详解： <img src="https://img-blog.csdnimg.cn/2021042717154497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 项目中正确使用： <img src="https://img-blog.csdnimg.cn/20210427171619682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="4-7-总结"><a href="#4-7-总结" class="headerlink" title="4.7 总结"></a>4.7 总结</h3><p>1、加锁</p>
<pre class="line-numbers language-none"><code class="language-none">// 1. 从redis中获取锁,set k1 v1 px 20000 nx
String uuid = UUID.randomUUID().toString();
Boolean lock = this.redisTemplate.opsForValue()
      .setIfAbsent("lock", uuid, 2, TimeUnit.SECONDS);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、使用lua释放锁</p>
<pre class="line-numbers language-none"><code class="language-none">// 2. 释放锁 del
String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end";
// 设置lua脚本返回的数据类型
DefaultRedisScript&lt;Long&gt; redisScript = new DefaultRedisScript&lt;&gt;();
// 设置lua脚本返回类型为Long
redisScript.setResultType(Long.class);
redisScript.setScriptText(script);
redisTemplate.execute(redisScript, Arrays.asList("lock"),uuid);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、重试</p>
<pre class="line-numbers language-none"><code class="language-none">Thread.sleep(500);
testLock();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>为了确保分布式锁可用，我们至少要确保锁的实现同时满足以下四个条件：</p>
<ul>
<li>互斥性。在任意时刻，只有一个客户端能持有锁。- 不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。- 解铃还须系铃人。加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。- 加锁和解锁必须具有原子性。<h1 id="十六、Redis6-0新功能"><a href="#十六、Redis6-0新功能" class="headerlink" title="十六、Redis6.0新功能"></a>十六、Redis6.0新功能</h1></li>
</ul>
<h2 id="1-ACL"><a href="#1-ACL" class="headerlink" title="1.ACL"></a>1.ACL</h2><h3 id="1-1-简介-1"><a href="#1-1-简介-1" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>Redis ACL是Access Control List（==访问控制列表==）的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接。</p>
<p>在Redis 5版本之前，Redis 安全规则只有密码控制 还有通过rename 来调整高危命令比如 flushdb ， KEYS* ， shutdown 等。Redis 6 则提供ACL的功能对用户进行更细粒度的权限控制 ：</p>
<ol>
<li>接入权限:用户名和密码1. 可以执行的命令1. 可以操作的 KEY<h3 id="1-2-命令"><a href="#1-2-命令" class="headerlink" title="1.2 命令"></a>1.2 命令</h3></li>
</ol>
<p>1、使用acl list命令展现用户权限列表 （1）数据说明 <img src="https://img-blog.csdnimg.cn/20210427172027133.png" alt="在这里插入图片描述"></p>
<p>2、使用acl cat命令 （1）查看添加权限指令类别 <img src="https://img-blog.csdnimg.cn/20210427172045247.png" alt="在这里插入图片描述"> （2）加参数类型名可以查看类型下具体命令 <img src="https://img-blog.csdnimg.cn/20210427172127847.png" alt="在这里插入图片描述"></p>
<p>3、使用acl whoami命令查看当前用户 <img src="https://img-blog.csdnimg.cn/20210427172156427.png" alt="在这里插入图片描述"></p>
<p>4、使用aclsetuser命令创建和编辑用户ACL （1）ACL规则 下面是有效ACL规则的列表。某些规则只是用于激活或删除标志，或对用户ACL执行给定更改的单个单词。其他规则是字符前缀，它们与命令或类别名称、键模式等连接在一起。</p>
<p><img src="https://img-blog.csdnimg.cn/20210427172311449.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210427172325670.png" alt="在这里插入图片描述"></p>
<p>（2）通过命令创建新用户默认权限 acl setuser user1 <img src="https://img-blog.csdnimg.cn/20210427172359369.png" alt="在这里插入图片描述"> 在上面的示例中，我根本没有指定任何规则。如果用户不存在，这将使用just created的默认属性来创建用户。如果用户已经存在，则上面的命令将不执行任何操作。</p>
<p>（3）设置有用户名、密码、ACL权限、并启用的用户 acl setuser user2 on &gt;password ~cached:* +get <img src="https://img-blog.csdnimg.cn/20210427172413518.png" alt="在这里插入图片描述"> （4）切换用户，验证权限 <img src="https://img-blog.csdnimg.cn/20210427172442266.png" alt="在这里插入图片描述"></p>
<h2 id="2-IO多线程"><a href="#2-IO多线程" class="headerlink" title="2.IO多线程"></a>2.IO多线程</h2><h3 id="2-1-简介-2"><a href="#2-1-简介-2" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>Redis6终于支持多线程了，告别单线程了吗？</p>
<p>==IO多线程其实指客户端交互部分的网络IO交互处理模块多线程==，而非执行命令多线程。R==edis6执行命令依然是单线程。==</p>
<h3 id="2-2-原理架构"><a href="#2-2-原理架构" class="headerlink" title="2.2 原理架构"></a>2.2 原理架构</h3><p>Redis 6 加入多线程,但跟 Memcached 这种从 IO处理到数据访问多线程的实现模式有些差异。Redis 的多线程部分只是用来处理网络数据的读写和协议解析，执行命令仍然是单线程。之所以这么设计是不想因为多线程而变得复杂，需要去控制 key、lua、事务，LPUSH/LPOP 等等的并发问题。整体的设计大体如下： <img src="https://img-blog.csdnimg.cn/2021042618034716.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> 另外，多线程IO默认也是不开启的，需要再配置文件中配置</p>
<pre class="line-numbers language-none"><code class="language-none">io-threads-do-reads  yes 
io-threads 4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="3-工具支持（Cluster）"><a href="#3-工具支持（Cluster）" class="headerlink" title="3.工具支持（Cluster）"></a>3.工具支持（Cluster）</h2><p>之前老版Redis想要搭集群需要单独安装ruby环境，Redis 5 将 redis-trib.rb 的功能集成到 redis-cli 。另外官方 redis-benchmark 工具开始支持 cluster 模式了，通过多线程的方式对多个分片进行压测。 <img src="https://img-blog.csdnimg.cn/20210426180828406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjU5NDc5Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="4-Redis新功能持续关注"><a href="#4-Redis新功能持续关注" class="headerlink" title="4.Redis新功能持续关注"></a>4.Redis新功能持续关注</h2><p>Redis6新功能还有：</p>
<ol>
<li><strong>RESP3新的 Redis 通信协议</strong>：优化服务端与客户端之间通信1. <strong>Client side caching客户端缓存</strong>：基于 RESP3 协议实现的客户端缓存功能。为了进一步提升缓存的性能，将客户端经常访问的数据cache到客户端。减少TCP网络交互。1. <strong>Proxy集群代理模式</strong>：Proxy 功能，让 Cluster 拥有像单实例一样的接入方式，降低大家使用cluster的门槛。不过需要注意的是代理不改变 Cluster 的功能限制，不支持的命令还是不会支持，比如跨 slot 的多Key操作。1. <strong>Modules API</strong>：Redis 6中模块API开发进展非常大，因为Redis Labs为了开发复杂的功能，从一开始就用上Redis模块。Redis可以变成一个框架，利用Modules来构建不同系统，而不需要从头开始写然后还要BSD许可。Redis一开始就是一个向编写各种系统开放的平台。</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">TheKing_Shun</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://thekingshun.github.io/2022/01/03/Redis6.2.x%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/">https://thekingshun.github.io/2022/01/03/Redis6.2.x%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">TheKing_Shun</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Redis/">
                                    <span class="chip bg-color">Redis</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 450px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/03/JVM%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8A%80%E6%9C%AF&%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="JVM 学习笔记（三）类加载与字节码技术&amp;内存模型">
                        
                        <span class="card-title">JVM 学习笔记（三）类加载与字节码技术&amp;内存模型</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">JVM学习笔记</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/03/MyBatis3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="MyBatis3">
                        
                        <span class="card-title">MyBatis3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MyBatis3/">
                        <span class="chip bg-color">MyBatis3</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 天启联盟<br />'
            + '文章作者: TheKing_Shun<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="song"
                   id="285100"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">TheKing_Shun</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "1";
                        var startDate = "3";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/TheKingShun" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:ws_hdu@hdu.edu.cn" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=962262149" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 962262149" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
